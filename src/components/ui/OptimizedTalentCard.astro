---
interface Props {
  person: {
    id: string;
    name: string;
    specialty: string;
    type: string;
    image?: string;
    location?: string;
    birth?: string;
    description?: string;
    specialties?: string[];
    age?: number;
    height?: string;
    eyeColor?: string;
    hairColor?: string;
    shoeSize?: string;
    dressSize?: string;
    imgs?: string[];
    portfolioUrl?: string;
  };
  priority?: boolean;
  size?: 'small' | 'medium' | 'large';
}

const { person, priority = false, size = 'medium' } = Astro.props;

const sizeClasses = {
  small: { width: 160, height: 200, containerClass: 'aspect-[3/4]' },
  medium: { width: 200, height: 300, containerClass: 'aspect-[2/3]' },
  large: { width: 300, height: 400, containerClass: 'aspect-[3/4]' }
};

const { width, height, containerClass } = sizeClasses[size];

// Generate placeholder with person's initials and color based on name
const getPlaceholderColor = (name: string) => {
  const colors = ['purple', 'blue', 'green', 'pink', 'orange', 'indigo'];
  const charSum = name.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
  return colors[charSum % colors.length];
};

const placeholderColor = getPlaceholderColor(person.name);
const initials = person.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
---

<div
  class="talent-card bg-offset rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer"
  data-type={person.type}
  data-talent-id={person.id}
  data-talent-name={person.name}
  data-talent-specialties={person.specialties ? JSON.stringify(person.specialties) : person.specialty}
  data-talent-description={person.description}
  data-talent-image={person.image}
  data-talent-location={person.location}
  data-talent-birth={person.birth}
  data-talent-age={person.age}
  data-talent-height={person.height}
  data-talent-eyecolor={person.eyeColor}
  data-talent-haircolor={person.hairColor}
  data-talent-shoesize={person.shoeSize}
  data-talent-dresssize={person.dressSize}
  data-talent-imgs={person.imgs ? JSON.stringify(person.imgs) : ''}
  data-talent-portfoliourl={person.portfolioUrl || ''}
>
  <div class={`${containerClass} bg-default/20 flex items-center justify-center relative overflow-hidden`}>

    <!-- Placeholder that shows immediately -->
    <div
      class={`placeholder-container absolute inset-0 bg-gradient-to-br from-${placeholderColor}-200 to-${placeholderColor}-300 flex flex-col items-center justify-center transition-opacity duration-500`}
      id={`placeholder-${person.id}`}
    >
      <div class={`text-4xl font-bold text-${placeholderColor}-700 mb-2`}>
        {initials}
      </div>
      <div class="w-8 h-8 border-2 border-current border-t-transparent rounded-full animate-spin opacity-50"></div>
    </div>

    <!-- Actual image with lazy loading -->
    {person.image && person.image.trim() !== "" ? (
      <img
        src={person.image}
        alt={`${person.name} - ${person.specialty}`}
        class="talent-image w-full h-full object-cover opacity-0 transition-opacity duration-500"
        width={width}
        height={height}
        loading={priority ? "eager" : "lazy"}
        decoding="async"
        onload={`
          this.style.opacity = '1';
          document.getElementById('placeholder-${person.id}').style.opacity = '0';
        `}
        onerror={`
          this.style.display = 'none';
          document.getElementById('placeholder-${person.id}').innerHTML =
            '<div class="text-center"><div class="text-2xl mb-2">${initials}</div><div class="text-xs opacity-60">Photo Coming Soon</div></div>';
        `}
        sizes="(max-width: 768px) 160px, (max-width: 1024px) 200px, 300px"
      />
    ) : (
      <div class="text-center text-default/60">
        <div class="text-2xl mb-2">{initials}</div>
        <div class="text-xs">Photo Coming Soon</div>
      </div>
    )}

    <!-- Info overlay -->
    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent pt-3 px-4 pb-4 text-white">
      <div class="space-y-1">
        <h3 class="talent-name leading-tight truncate">{person.name}</h3>

        <div class="flex flex-wrap gap-1 items-center">
          {person.location && (
            <div class="location-tag bg-black/40 text-white text-xs py-0.5 px-1.5 rounded-full backdrop-blur-sm flex items-center">
              <span class="mr-1">üìç</span>
              <span class="truncate max-w-20">{person.location}</span>
            </div>
          )}
        </div>

        <div class="flex flex-wrap gap-1 items-center">
          {person.specialties ? person.specialties.map(specialty => (
            <span class="specialty-tag bg-black/40 text-white text-xs py-0.5 px-1.5 rounded-full backdrop-blur-sm">
              {specialty}
            </span>
          )) : (
            <span class="specialty-tag bg-black/40 text-white text-xs py-0.5 px-1.5 rounded-full backdrop-blur-sm">
              {person.specialty}
            </span>
          )}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Ensure smooth loading transitions */
  .talent-image {
    transition: opacity 0.5s ease-in-out;
  }

  .placeholder-container {
    transition: opacity 0.5s ease-in-out;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .talent-card {
      transform-origin: center;
    }

    .talent-card:hover {
      transform: scale(1.02);
    }
  }

  /* Progressive image enhancement */
  .talent-image[loading="lazy"] {
    content-visibility: auto;
  }

  /* Skeleton loading animation */
  @keyframes shimmer {
    0% { background-position: -200px 0; }
    100% { background-position: calc(200px + 100%) 0; }
  }

  .placeholder-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.2),
      transparent
    );
    animation: shimmer 2s infinite;
  }
</style>
