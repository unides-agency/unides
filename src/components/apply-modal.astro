<!-- Apply Modal -->
<div id="apply-modal" class="fixed inset-0 z-50 bg-black bg-opacity-50 hidden flex items-center justify-center p-4" aria-hidden="true">
  <div class="w-full max-w-2xl mx-auto px-4 sm:px-6 py-10 bg-gray-50 dark:bg-[#0a353a] rounded-lg shadow-md max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-2xl font-bold text-purple-600 dark:text-purple-400 text-center flex-1">
        Apply to Join <span class="unides-brand">UNIDES</span>
      </h2>
      <button
        id="close-apply-modal"
        type="button"
        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl font-bold ml-4"
        aria-label="Close modal"
      >
        Ã—
      </button>
    </div>

    <div class="max-w-2xl mx-auto">
      <form id="apply-form" class="space-y-5 text-white dark:text-gray-900">
        <!-- Name -->
        <div>
          <label for="apply-name" class="block text-sm font-medium text-white dark:text-gray-900 mb-2">
            Full Name *
          </label>
          <input 
            id="apply-name"
            name="name"
            type="text" 
            class="w-full rounded px-4 py-3 border border-gray-600 dark:border-gray-400 bg-gray-800 dark:bg-white text-white dark:text-gray-900 placeholder-gray-300 dark:placeholder-gray-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
            placeholder="Your name"
            required
          >
        </div>

        <!-- Email -->
        <div>
          <label for="apply-email" class="block text-sm font-medium text-white dark:text-gray-900 mb-2">
            Email *
          </label>
          <input 
            id="apply-email"
            name="email"
            type="email" 
            class="w-full rounded px-4 py-3 border border-gray-600 dark:border-gray-400 bg-gray-800 dark:bg-white text-white dark:text-gray-900 placeholder-gray-300 dark:placeholder-gray-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
            placeholder="you@example.com"
            required
          >
        </div>

        <!-- Instagram -->
        <div>
          <label for="apply-instagram" class="block text-sm font-medium text-white dark:text-gray-900 mb-2">
            Instagram
          </label>
          <input 
            id="apply-instagram"
            name="instagram"
            type="url" 
            class="w-full rounded px-4 py-3 border border-gray-600 dark:border-gray-400 bg-gray-800 dark:bg-white text-white dark:text-gray-900 placeholder-gray-300 dark:placeholder-gray-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            placeholder="https://instagram.com/yourusername"
          >
        </div>

        <!-- About -->
        <div>
          <label for="apply-description" class="block text-sm font-medium text-white dark:text-gray-900 mb-2">
            About You *
          </label>
          <textarea 
            id="apply-description"
            name="description"
            rows="5" 
            class="w-full rounded px-4 py-3 border border-gray-600 dark:border-gray-400 bg-gray-800 dark:bg-white text-white dark:text-gray-900 placeholder-gray-300 dark:placeholder-gray-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none" 
            placeholder="Tell us about yourself..."
            required
            minlength="200"
          ></textarea>
        <p id="char-count-wrapper" class="text-xs text-red-500 mt-1">
          <span id="char-count">0</span> / 200 characters minimum
        </p>
        </div>

        <!-- Actions -->
        <div class="flex justify-end gap-4 pt-6">
          <button
            type="button"
            id="cancel-apply"
            class="border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 px-6 py-3 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors font-medium"
          >
            Cancel
          </button>
          <button
            type="submit"
            id="submit-apply"
            class="bg-purple-500 text-white px-6 py-3 rounded hover:bg-purple-600 transition-colors font-medium"
          >
            Submit Application
          </button>
        </div>
      </form>
      <div id="apply-form-status" class="hidden text-center text-sm mt-4"></div>
    </div>
  </div>
</div>

<script is:inline>
  // Define global functions first
  function openApplyModal() {
    console.log('Opening apply modal...');
    const modal = document.getElementById('apply-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      console.log('Modal opened');
    } else {
      console.error('Modal not found');
    }
  }

  function closeApplyModal() {
    const modal = document.getElementById('apply-modal');
    if (modal) {
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = 'auto';
      
      // Reset form
      const form = document.getElementById('apply-form');
      if (form) {
        form.reset();
        updateCharCount();
      }
    }
  }

  function updateCharCount() {
    const textarea = document.getElementById('apply-description');
    const charCount = document.getElementById('char-count');
    const charCountWrapper = document.getElementById('char-count-wrapper');
    if (textarea && charCount && charCountWrapper) {
      charCount.textContent = textarea.value.length;
      if (textarea.value.length >= 200) {
        charCountWrapper.classList.remove('text-red-500');
        charCountWrapper.classList.add('text-green-500');
      } else {
        charCountWrapper.classList.remove('text-green-500');
        charCountWrapper.classList.add('text-red-500');
      }
    }
  }

  // Make functions globally available
  if (typeof window !== 'undefined') {
    window.openApplyModal = openApplyModal;
    window.closeApplyModal = closeApplyModal;
  }

  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', function() {
    // Check if EmailJS is available
    if (typeof emailjs === 'undefined') {
      console.error('EmailJS is not loaded. Make sure to include the EmailJS script.');
      return;
    }
    
    // Initialize EmailJS
    emailjs.init({
      publicKey: "HAJhQWntEy40S-xyj",
    });

    // Event listeners
    const closeBtn = document.getElementById('close-apply-modal');
    const cancelBtn = document.getElementById('cancel-apply');
    const textarea = document.getElementById('apply-description');
    const form = document.getElementById('apply-form');
    const modal = document.getElementById('apply-modal');

    if (closeBtn) closeBtn.addEventListener('click', closeApplyModal);
    if (cancelBtn) cancelBtn.addEventListener('click', closeApplyModal);
    if (textarea) textarea.addEventListener('input', updateCharCount);

    // Form submission
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submit-apply');
        const formStatus = document.getElementById('apply-form-status');
        const originalText = submitBtn?.textContent;
        
        // Validate description length
        const description = document.getElementById('apply-description').value;
        if (description.length < 200) {
          if (formStatus) {
            formStatus.textContent = 'Description must be at least 200 characters long.';
            formStatus.className = 'block text-red-600 text-center text-sm';
          }
          return;
        }

        // Show loading state
        if (submitBtn) {
          submitBtn.textContent = 'Submitting...';
          submitBtn.disabled = true;
        }

        // Hide previous status messages
        if (formStatus) {
          formStatus.classList.add('hidden');
        }

        // Send form using EmailJS
        emailjs.sendForm('service_hm56mmb', 'template_i1utqhf', this)
          .then(() => {
            console.log('Application sent successfully!');
            
            // Show success message
            if (formStatus) {
              formStatus.textContent = 'Application submitted successfully! We\'ll review your application and get back to you soon.';
              formStatus.className = 'block text-green-600 text-center text-sm';
            }
            
            // Reset form after a delay
            setTimeout(() => {
              closeApplyModal();
            }, 3000);
          }, (error) => {
            console.log('Application failed...', error);
            
            // Show error message
            if (formStatus) {
              formStatus.textContent = 'Failed to submit application. Please try again or contact us directly at info.unides@gmail.com';
              formStatus.className = 'block text-red-600 text-center text-sm';
            }
          })
          .finally(() => {
            // Reset button state
            if (submitBtn) {
              submitBtn.textContent = originalText;
              submitBtn.disabled = false;
            }
          });
      });
    }

    // Close modal when clicking outside
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target.id === 'apply-modal') {
          closeApplyModal();
        }
      });
    }

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeApplyModal();
      }
    });

    // Initialize character count
    updateCharCount();
  });
</script>
