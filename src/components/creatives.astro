---
import ContentSection from "~/components/content-section.astro";
import { getCreatives } from "~/lib/creatives";

// Fetch creatives from Firebase
let creatives = [];
try {
  const allCreatives = await getCreatives();
  creatives = allCreatives.filter(creative => creative.enabled == true);
} catch (error) {
  console.error('Failed to load creatives:', error);
}
---

<ContentSection title="Creatives" id="creatives">
  <Fragment slot="lead">
    Meet our <span class="text-primary">creative professionals</span> who bring artistic vision
    and technical expertise to every project.
  </Fragment>

  {creatives.length === 0 ? (
      <div class="text-center py-8">
        <p class="text-default/60">No creatives available at the moment. Please check back later.</p>
      </div>
  ) : (
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        {creatives.map((creative) => (
            <div class="talent-card bg-offset rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105">
              <div class="aspect-[3/4] bg-default/20 flex items-center justify-center relative">
                {creative.image && creative.image.trim() !== "" ? (
                    <img
                      src={creative.image}
                      alt={`${creative.name} - ${creative.specialty}`}
                      class="w-full h-full object-cover"
                      loading="lazy"
                    />
                ) : (
                    <span class="text-default/60 text-xs">Portfolio Preview</span>
                )}
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-3 text-white">
                  <div class="space-y-2">
                    {/* Name - Featured prominently */}
                    <div class="text-white">
                      <h3 class="font-bold text-lg leading-tight">{creative.name}</h3>
                    </div>
                    
                    {/* Location and Specialty */}
                    <div class="flex flex-wrap gap-2 items-center">
                      {creative.location && (
                        <div class="bg-black/40 text-white text-xs py-1 px-2 rounded-full backdrop-blur-sm flex items-center">
                          <span class="mr-1">üìç</span>{creative.location}
                        </div>
                      )}
                      {creative.birth && (
                        <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm" title="Birth">
                          üéÇ {creative.birth}
                        </span>
                      )}
                      {creative.specialties && creative.specialties.length > 0 && (
                        creative.specialties.map((specialty) => (
                          <span class="bg-primary/80 text-white text-xs py-1 px-2 rounded-full">
                            {specialty.trim()}
                          </span>
                        ))
                      )}
                      {!creative.specialties && creative.specialty && (
                        <span class="bg-primary/80 text-white text-xs py-1 px-2 rounded-full">
                          {creative.specialty}
                        </span>
                      )}
                    </div>
                    
                    {/* Personal Details */}
                    <div class="flex flex-wrap gap-1">
                      {creative.height && (
                        <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm" title="Height">
                          üìè {creative.height}cm
                        </span>
                      )}
                      {creative.shoeSize && (
                        <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm" title="Shoe Size">
                          ÔøΩ {creative.shoeSize}
                        </span>
                      )}
                      {creative.dressSize && (
                        <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm" title="Dress Size">
                          ÔøΩ {creative.dressSize}
                        </span>
                      )}
                      {creative.eyeColor && (
                        <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm" title="Eye Color">
                          ÔøΩÔ∏è {creative.eyeColor}
                        </span>
                      )}
                      {creative.hairColor && (
                        <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm" title="Hair Color">
                          ÔøΩ {creative.hairColor}
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              </div>
              <div class="p-4">
                <div class="mb-3">
                  {/* Skills/Experience Tags */}
                  <div class="flex flex-wrap gap-1">
                    {creative.skills && creative.skills.split(',').map((skill) => (
                      <span class="text-xs px-2 py-0.5 bg-primary/20 text-primary rounded-full hover:bg-primary/30 transition-colors">
                        {skill.trim()}
                      </span>
                    ))}
                  </div>
                </div>
                <p class="text-default/80 text-xs mb-3 leading-relaxed line-clamp-2">{creative.description}</p>

                <button
                    class="view-profile-btn w-full bg-primary text-white px-3 py-2 rounded-md hover:bg-primary/80 transition-all duration-300 text-xs font-medium relative overflow-hidden group"
                    onclick={`openCreativeModal('${creative.id}', '${creative.name}', '${creative.specialty}', '${creative.description}', '${creative.image || ""}')`}
                >
                  <span class="relative z-10 group-hover:translate-x-1 transition-transform duration-300 inline-flex items-center">
                    View Portfolio
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 ml-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </span>
                  <span class="absolute inset-0 bg-gradient-to-r from-purple-600 to-primary transform scale-x-0 group-hover:scale-x-100 origin-left transition-transform duration-300"></span>
                </button>
              </div>
            </div>
        ))}
      </div>
  )}
</ContentSection>

<!-- Creative Modal -->
<div id="creative-modal" class="modal hidden fixed inset-0 z-50 bg-black bg-opacity-60 backdrop-blur-sm" aria-hidden="true">
  <div class="flex items-center justify-center min-h-screen p-4 sm:p-6 md:p-8">
    <div id="creative-modal-content" class="bg-default rounded-lg w-full max-w-sm sm:max-w-md md:max-w-2xl lg:max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl transform transition-transform duration-500 scale-95 opacity-0">
      <div class="p-6 sm:p-8 md:p-10">
        <div class="flex justify-between items-start mb-6">
          <h2 id="modal-title" class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-primary bg-clip-text text-transparent">Creative Portfolio</h2>
          <button
            id="close-creative-modal"
            type="button"
            class="text-default/60 hover:text-primary hover:rotate-90 transition-all duration-300 text-xl font-bold"
            aria-label="Close modal"
          >
            √ó
          </button>
        </div>

        <div class="space-y-6">
          <div class="flex flex-col md:flex-row gap-6">
            <div class="md:w-1/3">
              <div id="modal-image-container" class="aspect-[3/4] bg-default/20 rounded-lg flex items-center justify-center overflow-hidden">
                <img
                  id="modal-image"
                  src=""
                  alt=""
                  class="w-full h-full object-cover rounded-lg hidden"
                  loading="lazy"
                />
                <span id="modal-image-placeholder" class="text-default/60 text-sm">Portfolio Preview</span>
              </div>
            </div>

            <div class="md:w-2/3 space-y-4">
              <div>
                <h3 id="modal-name" class="text-xl font-bold text-default"></h3>
                <p id="modal-specialty" class="text-primary font-medium"></p>
              </div>

              <div>
                <h4 class="font-semibold mb-2">About</h4>
                <p id="modal-description" class="text-default/80 leading-relaxed"></p>
              </div>

              <div>
                <h4 class="font-semibold mb-3 text-lg">Personal Details</h4>
                <div id="modal-personal" class="grid grid-cols-2 gap-3 text-sm mb-4">
                  <!-- Personal details will be populated by JavaScript -->
                </div>
              </div>

              <div>
                <h4 class="font-semibold mb-3 text-lg">Skills & Experience</h4>
                <div id="modal-stats" class="grid grid-cols-2 gap-3 text-sm">
                  <!-- Stats will be populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>

          <div class="flex gap-4 pt-6 border-t border-default/20">
            <button class="flex-1 bg-primary text-white px-6 py-3 rounded-md hover:bg-primary/80 transition-all duration-300 font-medium shadow-md hover:shadow-lg hover:-translate-y-0.5">
              Contact Creative
            </button>
            <button 
              id="download-portfolio-btn"
              class="flex-1 border border-primary text-primary px-6 py-3 rounded-md hover:bg-primary/10 transition-all duration-300 font-medium hover:shadow-md hover:-translate-y-0.5"
              onclick="downloadPortfolio()"
            >
              Download Portfolio
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Get creatives data from the hidden script tag
  const creativesDataElement = document.getElementById('creatives-data');
  const creativesData = creativesDataElement ? JSON.parse(creativesDataElement.textContent || '[]') : [];
  let currentCreative = null;

  function openCreativeModal(id, name, specialty, description, image) {
    const modal = document.getElementById('creative-modal');
    const modalContent = document.getElementById('creative-modal-content');
    const modalTitle = document.getElementById('modal-title');
    const modalName = document.getElementById('modal-name');
    const modalSpecialty = document.getElementById('modal-specialty');
    const modalDescription = document.getElementById('modal-description');
    const modalImage = document.getElementById('modal-image');
    const modalImagePlaceholder = document.getElementById('modal-image-placeholder');
    const modalPersonal = document.getElementById('modal-personal');
    const modalStats = document.getElementById('modal-stats');

    // Find the creative data from the fetched data
    const creative = creativesData.find(c => c.id === id);
    
    // If not found in data, create a basic object
    if (!creative) {
      currentCreative = {
        id,
        name,
        specialty,
        description,
        image: image || "",
        stats: {}
      };
    } else {
      currentCreative = creative;
    }

    // Populate modal content
    modalTitle.textContent = `${currentCreative.name}'s Portfolio`;
    modalName.textContent = currentCreative.name;
    modalSpecialty.textContent = currentCreative.specialty;
    modalDescription.textContent = currentCreative.description;

    // Handle image in modal
    if (currentCreative.image && currentCreative.image.trim() !== "") {
      modalImage.src = currentCreative.image;
      modalImage.alt = `${currentCreative.name} - ${currentCreative.specialty}`;
      modalImage.classList.remove('hidden');
      modalImagePlaceholder.classList.add('hidden');
    } else {
      modalImage.classList.add('hidden');
      modalImagePlaceholder.classList.remove('hidden');
    }

    // Populate personal details
    modalPersonal.innerHTML = '';
    const personalFields = [
      { key: 'birth', label: 'Birth' },
      { key: 'height', label: 'Height' },
      { key: 'eyeColor', label: 'Eye Color' },
      { key: 'hairColor', label: 'Hair Color' },
      { key: 'shoeSize', label: 'Shoe Size' },
      { key: 'dressSize', label: 'Dress Size' }
    ];

    personalFields.forEach(({ key, label }) => {
      if (currentCreative[key]) {
        const detailDiv = document.createElement('div');
        detailDiv.className = 'flex justify-between p-2 bg-default/10 rounded';
        detailDiv.innerHTML = `
          <span class="text-default/60 font-medium">${label}:</span>
          <span class="text-default font-semibold">${currentCreative[key]}</span>
        `;
        modalPersonal.appendChild(detailDiv);
      }
    });

    // Populate stats
    modalStats.innerHTML = '';
    if (currentCreative.stats && Object.keys(currentCreative.stats).length > 0) {
      Object.entries(currentCreative.stats).forEach(([key, value]) => {
        const statDiv = document.createElement('div');
        statDiv.className = 'flex justify-between p-2 bg-default/10 rounded';
        statDiv.innerHTML = `
          <span class="text-default/60 font-medium capitalize">${key}:</span>
          <span class="text-default font-semibold">${value}</span>
        `;
        modalStats.appendChild(statDiv);
      });
    }

    // Show modal with animation
    modal.classList.remove('hidden');
    modal.setAttribute('aria-hidden', 'false');
    modal.dataset.currentCreativeId = id; // Store current creative ID
    document.body.style.overflow = 'hidden';
    
    // Animate modal content
    setTimeout(() => {
      if (modalContent) {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
      }
    }, 10);
  }

  function closeCreativeModal() {
    const modal = document.getElementById('creative-modal');
    const modalContent = document.getElementById('creative-modal-content');
    
    // Animate modal content out
    if (modalContent) {
      modalContent.classList.add('scale-95', 'opacity-0');
      modalContent.classList.remove('scale-100', 'opacity-100');
    }
    
    // Delay hiding the modal to allow animation to complete
    setTimeout(() => {
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = 'auto';
    }, 300);
  }

  async function downloadPortfolio() {
    const downloadBtn = document.getElementById('download-portfolio-btn');
    
    if (!downloadBtn) return;
    
    const originalText = downloadBtn.textContent;
    downloadBtn.disabled = true;
    downloadBtn.textContent = 'Loading Portfolio...';
    
    try {
      // Get current creative ID
      const modal = document.getElementById('creative-modal');
      const currentCreativeId = modal ? modal.dataset.currentCreativeId : null;
      
      if (!currentCreativeId) {
        throw new Error('No creative ID found');
      }

      // Get PDF URL from Firebase
      const pdfUrl = await getCreativePdfUrl(currentCreativeId);
      
      if (pdfUrl) {
        // Create a temporary link and trigger download
        const link = document.createElement('a');
        link.href = pdfUrl;
        link.download = ''; // Let the browser determine the filename from the URL
        link.target = '_blank'; // Open in new tab as fallback
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        // Show user-friendly message
        alert('Portfolio PDF not available for this creative.');
      }
      
    } catch (error) {
      console.error('Error downloading portfolio:', error);
      alert('Unable to download portfolio. Please try again later.');
    } finally {
      downloadBtn.disabled = false;
      downloadBtn.textContent = originalText;
    }
  }

  // Function to get creative PDF URL from Firebase
  async function getCreativePdfUrl(creativeId) {
    try {
      // Import Firebase functions dynamically
      const { doc, getDoc } = await import('firebase/firestore');
      const { db } = await import('~/lib/firebase');
      
      const creativeRef = doc(db, 'creatives', creativeId);
      const creativeDoc = await getDoc(creativeRef);
      
      if (creativeDoc.exists()) {
        const data = creativeDoc.data();
        return data.pdfUrl || null;
      }
      
      return null;
    } catch (error) {
      console.error('Error fetching creative PDF URL:', error);
      throw error;
    }
  }

  // Event listeners
  document.getElementById('close-creative-modal')?.addEventListener('click', closeCreativeModal);

  // Close modal when clicking outside
  document.getElementById('creative-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'creative-modal') {
      closeCreativeModal();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeCreativeModal();
    }
  });

  // Make functions globally available
  window.openCreativeModal = openCreativeModal;
  window.closeCreativeModal = closeCreativeModal;
  window.downloadPortfolio = downloadPortfolio;
</script>

<!-- Hidden data for JavaScript -->
<script id="creatives-data" type="application/json" set:html={JSON.stringify(creatives)}></script>

<style>
  .modal.is-open {
    @apply block;
  }
</style>