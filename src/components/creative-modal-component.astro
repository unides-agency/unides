---
// Creative Modal Component - Extracted from creatives.astro
---

<!-- Creative Modal HTML -->
<div id="creative-modal" class="modal hidden fixed inset-0 z-50 bg-black bg-opacity-60 backdrop-blur-sm" aria-hidden="true" role="dialog" aria-labelledby="creative-modal-title" aria-describedby="creative-modal-description">
  <div class="flex items-center justify-center min-h-screen p-4 sm:p-6 md:p-8">
    <div id="creative-modal-content" class="bg-default rounded-lg w-full max-w-sm sm:max-w-md md:max-w-2xl lg:max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl transform transition-transform duration-500 scale-95 opacity-0" role="document">
      <div class="p-6 sm:p-8 md:p-10">
        <div class="flex justify-between items-start mb-6">
          <h2 id="creative-modal-title" class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-primary bg-clip-text text-transparent">Creative Portfolio</h2>
          <button
            id="close-creative-modal"
            type="button"
            class="text-default/60 hover:text-primary hover:rotate-90 transition-all duration-300 text-xl font-bold focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 rounded-full p-2"
            aria-label="Close creative portfolio modal"
          >
            ×
          </button>
        </div>

        <div class="space-y-6">
          <!-- Hidden description for screen readers -->
          <div id="creative-modal-description" class="sr-only">
            Modal dialog displaying creative portfolio information including photos, personal details, and portfolio download option. Use Tab to navigate between elements, Escape to close.
          </div>

          <div class="flex flex-col md:flex-row gap-6">
            <!-- Image Section -->
            <div class="md:w-1/3">
              <div id="creative-modal-image-container" class="aspect-[3/4] bg-default/20 rounded-lg flex items-center justify-center overflow-hidden">
                <img
                  id="creative-modal-image"
                  src=""
                  alt=""
                  class="w-full h-full object-cover rounded-lg hidden"
                  loading="lazy"
                />
                <span id="creative-modal-image-placeholder" class="text-default/60 text-sm">Portfolio Preview</span>
              </div>
            </div>

            <!-- Info Section -->
            <div class="md:w-2/3 space-y-4">
              <!-- Name and Specialty -->
              <div>
                <h3 id="creative-modal-name" class="text-xl font-bold text-default"></h3>
                <p id="creative-modal-specialty" class="text-primary font-medium"></p>
              </div>

              <!-- About Section -->
              <div>
                <h4 class="font-semibold mb-2">About</h4>
                <p id="creative-modal-about" class="text-default/80 leading-relaxed"></p>
              </div>

              <!-- Personal Details Section -->
              <div>
                <h4 class="font-semibold mb-3 text-lg">Personal Details</h4>
                <div id="creative-modal-personal" class="grid grid-cols-2 gap-3 text-sm mb-4">
                  <!-- Personal details will be populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex pt-6 border-t border-default/20">
            <button 
              id="creative-download-portfolio-btn"
              class="w-full border border-primary text-primary px-6 py-3 rounded-md hover:bg-primary/10 transition-all duration-300 font-medium hover:shadow-md hover:-translate-y-0.5"
            >
              <span class="creative-portfolio-text">Download Portfolio</span>
              <span class="creative-portfolio-spinner hidden animate-spin ml-2">⏳</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Only initialize if this is the first load of the component
  if (!window.creativeModalInitialized) {
    window.creativeModalInitialized = true;

    // Main modal open function
    function openCreativeModal(id, name, specialties, description, image, birth, height, eyeColor, hairColor, shoeSize, dressSize, stats, imgs, pdfUrl) {
      const modal = document.getElementById('creative-modal');
      const modalContent = document.getElementById('creative-modal-content');
      const modalTitle = document.getElementById('creative-modal-title');
      const modalName = document.getElementById('creative-modal-name');
      const modalSpecialty = document.getElementById('creative-modal-specialty');
      const modalAbout = document.getElementById('creative-modal-about');
      const modalImage = document.getElementById('creative-modal-image');
      const modalImagePlaceholder = document.getElementById('creative-modal-image-placeholder');
      const modalPersonal = document.getElementById('creative-modal-personal');


      // Create creative object from passed parameters
      const currentCreative = {
        id,
        name,
        specialties: specialties || [],
        description,
        image: image || "",
        birth,
        height,
        eyeColor,
        hairColor,
        shoeSize,
        dressSize,
        stats: stats || {},
        imgs: imgs || [],
        pdfUrl
      };

      // Populate modal content
      modalTitle.textContent = `Creative's Portfolio`;
      modalName.textContent = currentCreative.name;
      
      // Handle specialty/specialties - check for both singular and plural
      let specialtyText = '';
      if (Array.isArray(currentCreative.specialties)) {
        specialtyText = currentCreative.specialties.join(' - ');
      }
      modalSpecialty.textContent = specialtyText;
      
      modalAbout.textContent = currentCreative.description;

      // Handle image in modal - use imgs array if available, fallback to single image
      let displayImage = '';
      if (currentCreative.imgs && Array.isArray(currentCreative.imgs) && currentCreative.imgs.length > 0) {
        displayImage = currentCreative.imgs[0]; // Use first image from imgs array
      } else if (currentCreative.image && currentCreative.image.trim() !== "") {
        displayImage = currentCreative.image; // Fallback to single image
      }

      if (displayImage) {
        modalImage.src = displayImage;
        modalImage.alt = `${currentCreative.name} - ${currentCreative.specialty}`;
        modalImage.classList.remove('hidden');
        modalImagePlaceholder.classList.add('hidden');
      } else {
        modalImage.classList.add('hidden');
        modalImagePlaceholder.classList.remove('hidden');
      }

      // Populate personal details
      modalPersonal.innerHTML = '';
      const personalFields = [
        { key: 'birth', label: 'Birth', value: birth },
        { key: 'height', label: 'Height', value: height },
        { key: 'eyeColor', label: 'Eye Color', value: eyeColor },
        { key: 'hairColor', label: 'Hair Color', value: hairColor },
        { key: 'shoeSize', label: 'Shoe Size', value: shoeSize },
        { key: 'dressSize', label: 'Dress Size', value: dressSize }
      ];

      personalFields.forEach(({ key, label, value }) => {
        if (value) {
          const detailDiv = document.createElement('div');
          detailDiv.className = 'flex justify-between p-2 bg-default/10 rounded';
          detailDiv.innerHTML = `
            <span class="text-default/60 font-medium">${label}:</span>
            <span class="text-default font-semibold">${value}</span>
          `;
          modalPersonal.appendChild(detailDiv);
        }
      });

      // Show modal with animation
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
      modal.dataset.currentCreativeId = id; // Store current creative ID
      modal.dataset.pdfUrl = pdfUrl || ''; // Store PDF URL
      document.body.style.overflow = 'hidden';
      
      // Animate modal content
      setTimeout(() => {
        if (modalContent) {
          modalContent.classList.remove('scale-95', 'opacity-0');
          modalContent.classList.add('scale-100', 'opacity-100');
        }
      }, 10);
    }

    function closeCreativeModal() {
      const modal = document.getElementById('creative-modal');
      const modalContent = document.getElementById('creative-modal-content');
      
      // Animate modal content out
      if (modalContent) {
        modalContent.classList.add('scale-95', 'opacity-0');
        modalContent.classList.remove('scale-100', 'opacity-100');
      }
      
      // Delay hiding the modal to allow animation to complete
      setTimeout(() => {
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = 'auto';
      }, 300);
    }

    async function downloadCreativePortfolio() {
      const downloadBtn = document.getElementById('creative-download-portfolio-btn');
      const portfolioText = downloadBtn.querySelector('.creative-portfolio-text');
      const portfolioSpinner = downloadBtn.querySelector('.creative-portfolio-spinner');
      
      if (!downloadBtn) return;
      
      const originalText = portfolioText.textContent;
      downloadBtn.disabled = true;
      portfolioText.textContent = 'Loading Portfolio...';
      portfolioSpinner.classList.remove('hidden');
      
      try {
        // Get current creative ID and PDF URL from stored data
        const modal = document.getElementById('creative-modal');
        const currentCreativeId = modal ? modal.dataset.currentCreativeId : null;
        const storedPdfUrl = modal ? modal.dataset.pdfUrl : null;
        
        if (!currentCreativeId) {
          throw new Error('No creative ID found');
        }

        console.log('PDF URL check:', storedPdfUrl);

        // Use stored PDF URL if available, otherwise try Firebase
        let pdfUrl = storedPdfUrl;
        
        if (!pdfUrl || pdfUrl.trim() === '') {
          console.log('No stored PDF URL, trying Firebase...');
          pdfUrl = await getCreativePdfUrl(currentCreativeId);
        }
        
        if (pdfUrl && pdfUrl.trim() !== '') {
          console.log('Opening PDF URL:', pdfUrl);
          // Create a temporary link and trigger download
          const link = document.createElement('a');
          link.href = pdfUrl;
          link.download = ''; // Let the browser determine the filename from the URL
          link.target = '_blank'; // Open in new tab as fallback
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } else {
          // Show user-friendly message
          console.log('No PDF URL found');
          alert('Portfolio PDF not available for this creative.');
        }
        
      } catch (error) {
        console.error('Error downloading portfolio:', error);
        alert('Unable to download portfolio. Please try again later.');
      } finally {
        downloadBtn.disabled = false;
        portfolioText.textContent = originalText;
        portfolioSpinner.classList.add('hidden');
      }
    }

    // Function to get creative PDF URL from Firebase
    async function getCreativePdfUrl(creativeId) {
      try {
        // Import Firebase functions dynamically
        const { doc, getDoc } = await import('firebase/firestore');
        const { db } = await import('~/lib/firebase');
        
        const creativeRef = doc(db, 'creatives', creativeId);
        const creativeDoc = await getDoc(creativeRef);
        
        if (creativeDoc.exists()) {
          const data = creativeDoc.data();
          return data.pdfUrl || null;
        }
        
        return null;
      } catch (error) {
        console.error('Error fetching creative PDF URL:', error);
        throw error;
      }
    }

    // Event listeners
    document.getElementById('close-creative-modal')?.addEventListener('click', closeCreativeModal);
    document.getElementById('creative-download-portfolio-btn')?.addEventListener('click', downloadCreativePortfolio);

    // Close modal when clicking outside
    document.getElementById('creative-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'creative-modal') {
        closeCreativeModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('creative-modal');
        if (modal && !modal.classList.contains('hidden')) {
          closeCreativeModal();
        }
      }
    });

    // Make functions globally available
    window.openCreativeModal = openCreativeModal;
    window.closeCreativeModal = closeCreativeModal;
    window.downloadCreativePortfolio = downloadCreativePortfolio;
  }
</script>

<style>
  .modal.is-open {
    @apply block;
  }
</style>
