---
// Creative Modal Component - Extracted from creatives.astro
---

<!-- Creative Modal HTML -->
<div id="creative-modal" class="modal hidden fixed inset-0 z-50 bg-black bg-opacity-60 backdrop-blur-sm" aria-hidden="true" role="dialog" aria-labelledby="creative-modal-title" aria-describedby="creative-modal-description">
  <div class="flex items-center justify-center min-h-screen p-4 min-w-0">
    <div id="creative-modal-content" class="bg-default rounded-lg max-w-6xl w-full max-h-[95vh] overflow-y-auto shadow-2xl transform transition-transform duration-500 scale-95 opacity-0 min-w-0" role="document">
      <div class="p-6 sm:p-8 md:p-10">
        <div class="flex justify-between items-start mb-6">
          <h2 id="creative-modal-title" class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-primary bg-clip-text text-transparent">Creative Portfolio</h2>
          <button
            id="close-creative-modal"
            type="button"
            class="text-default/60 hover:text-primary hover:rotate-90 transition-all duration-300 text-xl font-bold focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 rounded-full p-2"
            aria-label="Close creative portfolio modal"
          >
            ×
          </button>
        </div>

        <div class="space-y-6">
          <!-- Hidden description for screen readers -->
          <div id="creative-modal-description" class="sr-only">
            Modal dialog displaying creative portfolio information including photos, personal details, and portfolio download option. Use Tab to navigate between elements, Escape to close.
          </div>

          <div class="flex flex-col md:flex-row gap-6">
            <!-- Image Gallery Section -->
            <div class="w-full md:w-1/2">
              <div id="creative-modal-image-container" class="aspect-[3/4] bg-default/20 rounded-lg flex items-center justify-center overflow-hidden relative">
                <img
                  id="creative-modal-image"
                  src=""
                  alt=""
                  class="w-full h-full object-cover rounded-lg hidden"
                  loading="lazy"
                />
                <span id="creative-modal-image-placeholder" class="text-default/60 text-sm">Portfolio Preview</span>
                
                <!-- Image Navigation -->
                <div id="creative-modal-image-nav" class="absolute inset-0 flex items-center justify-between p-2 opacity-0 hover:opacity-100 transition-opacity duration-300 hidden">
                  <button
                    id="creative-modal-prev-btn"
                    class="bg-black/50 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur-sm transition-all duration-300 hover:scale-110"
                    aria-label="Previous image"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  <button
                    id="creative-modal-next-btn"
                    class="bg-black/50 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur-sm transition-all duration-300 hover:scale-110"
                    aria-label="Next image"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                </div>
                
                <!-- Image Counter -->
                <div id="creative-modal-image-counter" class="absolute bottom-2 left-2 bg-black/50 text-white text-xs px-2 py-1 rounded-full backdrop-blur-sm hidden">
                  <span id="creative-modal-current-image">1</span>/<span id="creative-modal-total-images">1</span>
                </div>
              </div>
              
              <!-- Image Thumbnails -->
              <div id="creative-modal-thumbnails" class="mt-3 flex gap-2 overflow-x-auto hidden">
                <!-- Thumbnails will be populated by JavaScript -->
              </div>
            </div>

            <!-- Info Section -->
            <div class="w-full md:w-1/2 space-y-4">
              <!-- Name and Specialty -->
              <div>
                <h3 id="creative-modal-name" class="text-xl font-bold text-default"></h3>
                <p id="creative-modal-specialty" class="text-primary font-medium"></p>
              </div>

              <!-- About Section -->
              <div>
                <h4 class="font-semibold mb-2">About</h4>
                <p id="creative-modal-about" class="text-default/80 leading-relaxed"></p>
              </div>

              <!-- Personal Details Section -->
              <div>
                <h4 class="font-semibold mb-3 text-lg">Personal Details</h4>
                <div id="creative-modal-personal" class="grid grid-cols-2 gap-3 text-sm mb-4">
                  <!-- Personal details will be populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex pt-6 border-t border-default/20">
            <button 
              id="creative-download-portfolio-btn"
              class="w-full border border-primary text-primary px-6 py-3 rounded-md hover:bg-primary/10 transition-all duration-300 font-medium hover:shadow-md hover:-translate-y-0.5"
            >
              <span class="creative-portfolio-text">Download Portfolio</span>
              <span class="creative-portfolio-spinner hidden animate-spin ml-2">⏳</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Only initialize if this is the first load of the component
  if (!window.creativeModalInitialized) {
    window.creativeModalInitialized = true;

    // Main modal open function
    function openCreativeModal(id, name, specialties, description, image, birth, height, eyeColor, hairColor, shoeSize, dressSize, stats, imgs, pdfUrl) {
      const modal = document.getElementById('creative-modal');
      const modalContent = document.getElementById('creative-modal-content');
      const modalTitle = document.getElementById('creative-modal-title');
      const modalName = document.getElementById('creative-modal-name');
      const modalSpecialty = document.getElementById('creative-modal-specialty');
      const modalAbout = document.getElementById('creative-modal-about');
      const modalImage = document.getElementById('creative-modal-image');
      const modalImagePlaceholder = document.getElementById('creative-modal-image-placeholder');
      const modalPersonal = document.getElementById('creative-modal-personal');
      const modalImageNav = document.getElementById('creative-modal-image-nav');
      const modalImageCounter = document.getElementById('creative-modal-image-counter');
      const modalCurrentImage = document.getElementById('creative-modal-current-image');
      const modalTotalImages = document.getElementById('creative-modal-total-images');
      const modalThumbnails = document.getElementById('creative-modal-thumbnails');

      // Create creative object from passed parameters
      const currentCreative = {
        id,
        name,
        specialties: specialties || [],
        description,
        image: image || "",
        birth,
        height,
        eyeColor,
        hairColor,
        shoeSize,
        dressSize,
        stats: stats || {},
        imgs: imgs || [],
        pdfUrl
      };

      // Store current image index
      let currentImageIndex = 0;
      
      // Collect all available images
      const allImages = [];
      if (currentCreative.imgs && Array.isArray(currentCreative.imgs) && currentCreative.imgs.length > 0) {
        allImages.push(...currentCreative.imgs);
      } else if (currentCreative.image && currentCreative.image.trim() !== "") {
        allImages.push(currentCreative.image);
      }

      // Populate modal content
      modalTitle.textContent = `Creative's Portfolio`;
      modalName.textContent = currentCreative.name;
      
      // Handle specialty/specialties - check for both singular and plural
      let specialtyText = '';
      if (Array.isArray(currentCreative.specialties)) {
        specialtyText = currentCreative.specialties.join(' - ');
      }
      modalSpecialty.textContent = specialtyText;
      
      modalAbout.textContent = currentCreative.description;

      // Handle image gallery
      function updateImageDisplay() {
        if (allImages.length > 0) {
          modalImage.src = allImages[currentImageIndex];
          modalImage.alt = `${currentCreative.name} - Image ${currentImageIndex + 1}`;
          modalImage.classList.remove('hidden');
          modalImagePlaceholder.classList.add('hidden');
          
          // Update counter
          modalCurrentImage.textContent = currentImageIndex + 1;
          modalTotalImages.textContent = allImages.length;
          
          // Show/hide navigation and counter based on image count
          if (allImages.length > 1) {
            modalImageNav.classList.remove('hidden');
            modalImageCounter.classList.remove('hidden');
          } else {
            modalImageNav.classList.add('hidden');
            modalImageCounter.classList.add('hidden');
          }
        } else {
          modalImage.classList.add('hidden');
          modalImagePlaceholder.classList.remove('hidden');
          modalImageNav.classList.add('hidden');
          modalImageCounter.classList.add('hidden');
        }
      }

      // Initialize image display
      updateImageDisplay();

      // Create thumbnails if multiple images
      if (allImages.length > 1) {
        modalThumbnails.innerHTML = '';
        allImages.forEach((imgSrc, index) => {
          const thumbnail = document.createElement('div');
          thumbnail.className = `w-12 h-12 rounded cursor-pointer overflow-hidden border-2 transition-all duration-300 ${
            index === currentImageIndex ? 'border-primary' : 'border-transparent hover:border-primary/50'
          }`;
          thumbnail.innerHTML = `
            <img 
              src="${imgSrc}" 
              alt="Thumbnail ${index + 1}" 
              class="w-full h-full object-cover"
              loading="lazy"
            />
          `;
          thumbnail.addEventListener('click', () => {
            currentImageIndex = index;
            updateImageDisplay();
            updateThumbnailSelection();
          });
          modalThumbnails.appendChild(thumbnail);
        });
        modalThumbnails.classList.remove('hidden');
      } else {
        modalThumbnails.classList.add('hidden');
      }

      // Update thumbnail selection
      function updateThumbnailSelection() {
        const thumbnails = modalThumbnails.querySelectorAll('div');
        thumbnails.forEach((thumb, index) => {
          if (index === currentImageIndex) {
            thumb.classList.remove('border-transparent');
            thumb.classList.add('border-primary');
          } else {
            thumb.classList.remove('border-primary');
            thumb.classList.add('border-transparent');
          }
        });
      }

      // Navigation functions
      function showPreviousImage() {
        if (allImages.length > 1) {
          currentImageIndex = (currentImageIndex - 1 + allImages.length) % allImages.length;
          updateImageDisplay();
          updateThumbnailSelection();
        }
      }

      function showNextImage() {
        if (allImages.length > 1) {
          currentImageIndex = (currentImageIndex + 1) % allImages.length;
          updateImageDisplay();
          updateThumbnailSelection();
        }
      }

      // Add navigation event listeners
      const prevBtn = document.getElementById('creative-modal-prev-btn');
      const nextBtn = document.getElementById('creative-modal-next-btn');
      
      if (prevBtn) {
        prevBtn.removeEventListener('click', showPreviousImage);
        prevBtn.addEventListener('click', showPreviousImage);
      }
      
      if (nextBtn) {
        nextBtn.removeEventListener('click', showNextImage);
        nextBtn.addEventListener('click', showNextImage);
      }

      // Keyboard navigation
      function handleKeydown(e) {
        if (modal && !modal.classList.contains('hidden')) {
          if (e.key === 'ArrowLeft') {
            e.preventDefault();
            showPreviousImage();
          } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            showNextImage();
          }
        }
      }

      // Remove existing keydown listener and add new one
      document.removeEventListener('keydown', handleKeydown);
      document.addEventListener('keydown', handleKeydown);

      // Populate personal details
      modalPersonal.innerHTML = '';
      const personalFields = [
        { key: 'birth', label: 'Birth', value: birth },
        { key: 'height', label: 'Height', value: height },
        { key: 'eyeColor', label: 'Eye Color', value: eyeColor },
        { key: 'hairColor', label: 'Hair Color', value: hairColor },
        { key: 'shoeSize', label: 'Shoe Size', value: shoeSize },
        { key: 'dressSize', label: 'Dress Size', value: dressSize }
      ];

      personalFields.forEach(({ key, label, value }) => {
        if (value) {
          const detailDiv = document.createElement('div');
          detailDiv.className = 'flex justify-between p-2 bg-default/10 rounded';
          detailDiv.innerHTML = `
            <span class="text-default/60 font-medium">${label}:</span>
            <span class="text-default font-semibold">${value}</span>
          `;
          modalPersonal.appendChild(detailDiv);
        }
      });

      // Show modal with animation
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
      modal.dataset.currentCreativeId = id; // Store current creative ID
      modal.dataset.pdfUrl = pdfUrl || ''; // Store PDF URL
      document.body.style.overflow = 'hidden';
      
      // Animate modal content
      setTimeout(() => {
        if (modalContent) {
          modalContent.classList.remove('scale-95', 'opacity-0');
          modalContent.classList.add('scale-100', 'opacity-100');
        }
      }, 10);
    }

    function closeCreativeModal() {
      const modal = document.getElementById('creative-modal');
      const modalContent = document.getElementById('creative-modal-content');
      
      // Animate modal content out
      if (modalContent) {
        modalContent.classList.add('scale-95', 'opacity-0');
        modalContent.classList.remove('scale-100', 'opacity-100');
      }
      
      // Delay hiding the modal to allow animation to complete
      setTimeout(() => {
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = 'auto';
      }, 300);
    }

    async function downloadCreativePortfolio() {
      const downloadBtn = document.getElementById('creative-download-portfolio-btn');
      const portfolioText = downloadBtn.querySelector('.creative-portfolio-text');
      const portfolioSpinner = downloadBtn.querySelector('.creative-portfolio-spinner');
      
      if (!downloadBtn) return;
      
      const originalText = portfolioText.textContent;
      downloadBtn.disabled = true;
      portfolioText.textContent = 'Loading Portfolio...';
      portfolioSpinner.classList.remove('hidden');
      
      try {
        // Get current creative ID and PDF URL from stored data
        const modal = document.getElementById('creative-modal');
        const currentCreativeId = modal ? modal.dataset.currentCreativeId : null;
        const storedPdfUrl = modal ? modal.dataset.pdfUrl : null;
        
        if (!currentCreativeId) {
          throw new Error('No creative ID found');
        }

        console.log('PDF URL check:', storedPdfUrl);

        // Use stored PDF URL if available, otherwise try Firebase
        let pdfUrl = storedPdfUrl;
        
        if (!pdfUrl || pdfUrl.trim() === '') {
          console.log('No stored PDF URL, trying Firebase...');
          pdfUrl = await getCreativePdfUrl(currentCreativeId);
        }
        
        if (pdfUrl && pdfUrl.trim() !== '') {
          console.log('Opening PDF URL:', pdfUrl);
          // Create a temporary link and trigger download
          const link = document.createElement('a');
          link.href = pdfUrl;
          link.download = ''; // Let the browser determine the filename from the URL
          link.target = '_blank'; // Open in new tab as fallback
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } else {
          // Show user-friendly message
          console.log('No PDF URL found');
          alert('Portfolio PDF not available for this creative.');
        }
        
      } catch (error) {
        console.error('Error downloading portfolio:', error);
        alert('Unable to download portfolio. Please try again later.');
      } finally {
        downloadBtn.disabled = false;
        portfolioText.textContent = originalText;
        portfolioSpinner.classList.add('hidden');
      }
    }

    // Function to get creative PDF URL from Firebase
    async function getCreativePdfUrl(creativeId) {
      try {
        // Import Firebase functions dynamically
        const { doc, getDoc } = await import('firebase/firestore');
        const { db } = await import('~/lib/firebase');
        
        const creativeRef = doc(db, 'creatives', creativeId);
        const creativeDoc = await getDoc(creativeRef);
        
        if (creativeDoc.exists()) {
          const data = creativeDoc.data();
          return data.pdfUrl || null;
        }
        
        return null;
      } catch (error) {
        console.error('Error fetching creative PDF URL:', error);
        throw error;
      }
    }

    // Event listeners
    document.getElementById('close-creative-modal')?.addEventListener('click', closeCreativeModal);
    document.getElementById('creative-download-portfolio-btn')?.addEventListener('click', downloadCreativePortfolio);

    // Close modal when clicking outside
    document.getElementById('creative-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'creative-modal') {
        closeCreativeModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('creative-modal');
        if (modal && !modal.classList.contains('hidden')) {
          closeCreativeModal();
        }
      }
    });

    // Make functions globally available
    window.openCreativeModal = openCreativeModal;
    window.closeCreativeModal = closeCreativeModal;
    window.downloadCreativePortfolio = downloadCreativePortfolio;
  }
</script>

<style>
  .modal.is-open {
    @apply block;
  }
</style>
