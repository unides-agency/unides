---
// Creative Modal Component - Extracted from creatives.astro
---

<!-- Creative Modal HTML -->
<div id="creative-modal" class="modal hidden fixed inset-0 z-50 bg-black bg-opacity-60 backdrop-blur-sm" aria-hidden="true" role="dialog" aria-labelledby="creative-modal-title" aria-describedby="creative-modal-description">
  <div class="flex items-center justify-center min-h-screen p-4 min-w-0 bg-black bg-opacity-80 sm:bg-black sm:bg-opacity-60">
    <div id="creative-modal-content" class="bg-default rounded-lg max-w-6xl w-full max-h-[95vh] overflow-y-auto shadow-2xl transform transition-transform duration-500 scale-95 opacity-0 min-w-0" role="document">
      <div class="p-6 min-w-0">
        <div class="flex justify-between items-start mb-6 min-w-0">
          <h2 id="creative-modal-title" class="text-3xl font-bold text-default bg-gradient-to-r from-purple-400 to-primary bg-clip-text text-transparent min-w-0">Creative Portfolio</h2>
          <button
            id="close-creative-modal"
            type="button"
            class="text-default/60 hover:text-primary hover:rotate-90 transition-all duration-300 text-2xl font-bold focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 rounded-full p-2"
            aria-label="Close creative portfolio modal"
          >
            ×
          </button>
        </div>

        <div class="space-y-6 min-w-0">
          <!-- Hidden description for screen readers -->
          <div id="creative-modal-description" class="sr-only">
            Modal dialog displaying creative portfolio information including photos, personal details, and portfolio download option. Use Tab to navigate between elements, Escape to close.
          </div>

          <div class="flex flex-col-reverse lg:flex-row gap-8 min-w-0">
            <!-- Image Gallery Section -->
            <div class="w-full lg:w-1/2 min-w-0">
              <div id="creative-modal-image-gallery" class="space-y-4 min-w-0">
                <!-- Main image -->
                <div class="aspect-[3/4] bg-default/20 rounded-lg flex items-center justify-center overflow-hidden relative">
                  <img
                    id="creative-modal-image"
                    src=""
                    alt=""
                    class="w-full h-full object-cover rounded-lg hidden"
                    loading="lazy"
                  />
                  <span id="creative-modal-image-placeholder" class="text-default/60 text-sm">Portfolio Preview</span>
                  
                  <!-- Image Navigation -->
                  <div id="creative-modal-image-nav" class="absolute inset-0 flex items-center justify-between p-2 opacity-0 hover:opacity-100 transition-opacity duration-300 hidden">
                    <button
                      id="creative-modal-prev-btn"
                      class="bg-black/50 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur-sm transition-all duration-300 hover:scale-110"
                      aria-label="Previous image"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                      </svg>
                    </button>
                    <button
                      id="creative-modal-next-btn"
                      class="bg-black/50 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur-sm transition-all duration-300 hover:scale-110"
                      aria-label="Next image"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                      </svg>
                    </button>
                  </div>
                  
                  <!-- Image Counter -->
                  <div id="creative-modal-image-counter" class="absolute bottom-2 left-2 bg-black/50 text-white text-xs px-2 py-1 rounded-full backdrop-blur-sm hidden">
                    <span id="creative-modal-current-image">1</span>/<span id="creative-modal-total-images">1</span>
                  </div>
                </div>
                
                <!-- Image Thumbnails -->
                <div id="creative-modal-thumbnails" class="grid grid-cols-4 gap-2 hidden">
                  <!-- Thumbnails will be populated by JavaScript -->
                </div>
              </div>
            </div>

            <!-- Info Section - below gallery on mobile, right on desktop -->
            <div class="w-full lg:w-1/2 space-y-6 min-w-0">
              <!-- Name and Specialty -->
              <div class="min-w-0">
                <h3 id="creative-modal-name" class="text-2xl font-bold text-default min-w-0"></h3>
                <p id="creative-modal-specialty" class="text-primary font-medium text-lg min-w-0"></p>
              </div>

              <!-- About Section -->
              <div class="min-w-0">
                <h4 class="font-semibold mb-3 text-lg text-default">About</h4>
                <p id="creative-modal-about" class="text-default/80 leading-relaxed min-w-0"></p>
              </div>

              <!-- Personal Details Section -->
              <div class="min-w-0">
                <h4 class="font-semibold mb-3 text-lg text-default">Personal Details</h4>
                <div id="creative-modal-personal" class="grid grid-cols-2 gap-4 text-sm min-w-0">
                  <!-- Personal details will be populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-4 pt-6 border-t border-default/20 min-w-0">
            <button 
              id="creative-download-portfolio-btn"
              class="flex-1 border-2 border-primary text-primary px-8 py-4 rounded-lg hover:bg-primary/10 hover:border-purple-600 hover:text-purple-600 focus:ring-2 focus:ring-purple-400 focus:outline-none transition-all duration-300 font-semibold text-lg hover:shadow-lg hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none min-w-0"
            >
              <span class="creative-portfolio-text">Download Portfolio</span>
              <span class="creative-portfolio-spinner hidden animate-spin ml-2">⏳</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Only initialize if this is the first load of the component
  if (!window.creativeModalInitialized) {
    window.creativeModalInitialized = true;

    // Main modal open function
    function openCreativeModal(id, name, specialties, description, image, personalInfo, stats, imgs, pdfUrl) {
      const modal = document.getElementById('creative-modal');
      const modalContent = document.getElementById('creative-modal-content');
      const modalTitle = document.getElementById('creative-modal-title');
      const modalName = document.getElementById('creative-modal-name');
      const modalSpecialty = document.getElementById('creative-modal-specialty');
      const modalAbout = document.getElementById('creative-modal-about');
      const modalImage = document.getElementById('creative-modal-image');
      const modalImagePlaceholder = document.getElementById('creative-modal-image-placeholder');
      const modalPersonal = document.getElementById('creative-modal-personal');
      const modalImageNav = document.getElementById('creative-modal-image-nav');
      const modalImageCounter = document.getElementById('creative-modal-image-counter');
      const modalCurrentImage = document.getElementById('creative-modal-current-image');
      const modalTotalImages = document.getElementById('creative-modal-total-images');
      const modalThumbnails = document.getElementById('creative-modal-thumbnails');

      // Create creative object from passed parameters
      const currentCreative = {
        id,
        name,
        specialties: specialties || [],
        description,
        image: image || "",
        personalInfo: personalInfo || {},
        stats: stats || {},
        imgs: imgs || [],
        pdfUrl
      };

      // Store current image index
      let currentImageIndex = 0;
      
      // Collect all available media (images and YouTube videos)
      const allMedia = [];
      function isYouTubeUrl(url) {
        // Accepts all YouTube URLs, including /live/, /watch, /shorts, etc.
        return typeof url === 'string' && /(youtube\.com|youtu\.be)\//.test(url);
      }
      if (currentCreative.imgs && Array.isArray(currentCreative.imgs) && currentCreative.imgs.length > 0) {
        allMedia.push(...currentCreative.imgs);
      } else if (currentCreative.image && currentCreative.image.trim() !== "") {
        allMedia.push(currentCreative.image);
      }

      // Populate modal content
      modalTitle.textContent = `Creative's Portfolio`;
      modalName.textContent = currentCreative.name;
      
      // Handle specialty/specialties - check for both singular and plural
      let specialtyText = '';
      if (Array.isArray(currentCreative.specialties)) {
        specialtyText = currentCreative.specialties.join(' - ');
      }
      modalSpecialty.textContent = specialtyText;
      
      modalAbout.textContent = currentCreative.description;

      // Handle media gallery (images and YouTube videos)
      function updateMediaDisplay() {
        // Hide all main display elements first
        modalImage.classList.add('hidden');
        modalImagePlaceholder.classList.add('hidden');
        // Remove any existing video iframe
        let videoIframe = document.getElementById('creative-modal-video');
        if (videoIframe && videoIframe.parentNode) {
          videoIframe.parentNode.removeChild(videoIframe);
        }

        if (allMedia.length > 0) {
          const media = allMedia[currentImageIndex];
          if (isYouTubeUrl(media)) {
            // Show YouTube video
            // Support /live/ and other YouTube URL formats
            let videoId = null;
            // Try to extract video ID from various YouTube URL formats
            const patterns = [
              /[?&]v=([\w-]{11})/, // watch?v=VIDEOID
              /youtu\.be\/([\w-]{11})/, // youtu.be/VIDEOID
              /youtube\.com\/embed\/([\w-]{11})/, // embed/VIDEOID
              /youtube\.com\/shorts\/([\w-]{11})/, // shorts/VIDEOID
              /youtube\.com\/live\/([\w-]{11})/, // live/VIDEOID
              /youtube\.com\/v\/([\w-]{11})/ // v/VIDEOID
            ];
            for (const pattern of patterns) {
              const match = media.match(pattern);
              if (match) {
                videoId = match[1];
                break;
              }
            }
            if (videoId) {
              // Create a wrapper div to preserve aspect ratio
              const wrapper = document.createElement('div');
              wrapper.className = 'absolute inset-0 w-full h-full flex items-center justify-center aspect-[3/4]';
              wrapper.style.position = 'absolute';
              wrapper.style.inset = '0';
              wrapper.style.width = '100%';
              wrapper.style.height = '100%';
              // Create the iframe
              const iframe = document.createElement('iframe');
              iframe.id = 'creative-modal-video';
              iframe.width = '100%';
              iframe.height = '100%';
              iframe.className = 'w-full h-full aspect-[3/4] rounded-lg';
              iframe.src = `https://www.youtube.com/embed/${videoId}?rel=0&showinfo=0`;
              iframe.title = 'YouTube video player';
              // Set allow and allowfullscreen as attributes for maximum compatibility
              iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
              iframe.setAttribute('allowfullscreen', '');
              // Optionally add sandbox for extra compatibility (remove if issues)
              // iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-presentation allow-popups allow-forms');
              wrapper.appendChild(iframe);
              // Insert the wrapper before the modalImage
              modalImage.parentNode.insertBefore(wrapper, modalImage);
              // Hide the placeholder
              modalImagePlaceholder.classList.add('hidden');
            } else {
              modalImagePlaceholder.classList.remove('hidden');
            }
          } else {
            // Show image
            modalImage.src = media;
            modalImage.alt = `${currentCreative.name} - Image ${currentImageIndex + 1}`;
            modalImage.classList.remove('hidden');
          }
          // Update counter
          modalCurrentImage.textContent = currentImageIndex + 1;
          modalTotalImages.textContent = allMedia.length;
          // Show/hide navigation and counter based on media count
          if (allMedia.length > 1) {
            modalImageNav.classList.remove('hidden');
            modalImageCounter.classList.remove('hidden');
          } else {
            modalImageNav.classList.add('hidden');
            modalImageCounter.classList.add('hidden');
          }
        } else {
          modalImagePlaceholder.classList.remove('hidden');
          modalImageNav.classList.add('hidden');
          modalImageCounter.classList.add('hidden');
        }
      }

      // Initialize media display
      updateMediaDisplay();

      // Create thumbnails if multiple media (images or YouTube videos)
      if (allMedia.length > 1) {
        modalThumbnails.innerHTML = '';
        allMedia.forEach((mediaSrc, index) => {
          const thumbnailDiv = document.createElement('div');
          thumbnailDiv.className = 'aspect-square bg-default/20 rounded overflow-hidden cursor-pointer hover:opacity-80 hover:ring-2 hover:ring-primary transition-all duration-200 focus:ring-2 focus:ring-primary focus:outline-none flex items-center justify-center';
          thumbnailDiv.tabIndex = 0;
          thumbnailDiv.setAttribute('role', 'button');
          thumbnailDiv.setAttribute('aria-label', `View media ${index + 1} of ${allMedia.length}`);
          if (isYouTubeUrl(mediaSrc)) {
            // Show YouTube thumbnail
            let videoId = null;
            const patterns = [
              /[?&]v=([\w-]{11})/, // watch?v=VIDEOID
              /youtu\.be\/([\w-]{11})/, // youtu.be/VIDEOID
              /youtube\.com\/embed\/([\w-]{11})/, // embed/VIDEOID
              /youtube\.com\/shorts\/([\w-]{11})/, // shorts/VIDEOID
              /youtube\.com\/live\/([\w-]{11})/, // live/VIDEOID
              /youtube\.com\/v\/([\w-]{11})/ // v/VIDEOID
            ];
            for (const pattern of patterns) {
              const match = mediaSrc.match(pattern);
              if (match) {
                videoId = match[1];
                break;
              }
            }
            if (videoId) {
              thumbnailDiv.innerHTML = `<div class="relative w-full h-full flex items-center justify-center bg-black"><img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" alt="YouTube Video Thumbnail" class="w-full h-full object-cover" /><span class="absolute inset-0 flex items-center justify-center"><svg class="w-8 h-8 text-white opacity-90" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></span></div>`;
            } else {
              thumbnailDiv.innerHTML = `<span class="text-xs text-default/60">Video</span>`;
            }
          } else {
            // Show image thumbnail
            thumbnailDiv.innerHTML = `<img src="${mediaSrc}" alt="${currentCreative.name} - Image ${index + 1}" class="w-full h-full object-cover" loading="lazy" />`;
          }
          const handleMediaClick = function() {
            currentImageIndex = index;
            updateMediaDisplay();
            // Update active thumbnail styling
            const thumbs = modalThumbnails.querySelectorAll('div');
            thumbs.forEach(thumb => {
              thumb.classList.remove('ring-2', 'ring-primary');
            });
            thumbnailDiv.classList.add('ring-2', 'ring-primary');
          };
          thumbnailDiv.addEventListener('click', handleMediaClick);
          thumbnailDiv.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handleMediaClick();
            }
          });
          modalThumbnails.appendChild(thumbnailDiv);
        });
        // Mark first thumbnail as active
        if (modalThumbnails.firstChild) {
          modalThumbnails.firstChild.classList.add('ring-2', 'ring-primary');
        }
        modalThumbnails.classList.remove('hidden');
      } else {
        modalThumbnails.classList.add('hidden');
      }

      // Navigation functions
      function showPreviousMedia() {
        if (allMedia.length > 1) {
          currentImageIndex = (currentImageIndex - 1 + allMedia.length) % allMedia.length;
          updateMediaDisplay();
          updateThumbnailHighlight();
        }
      }

      function showNextMedia() {
        if (allMedia.length > 1) {
          currentImageIndex = (currentImageIndex + 1) % allMedia.length;
          updateMediaDisplay();
          updateThumbnailHighlight();
        }
      }

      // Update thumbnail highlight
      function updateThumbnailHighlight() {
        const thumbnails = modalThumbnails.querySelectorAll('div');
        thumbnails.forEach((thumb, index) => {
          if (index === currentImageIndex) {
            thumb.classList.add('ring-2', 'ring-primary');
          } else {
            thumb.classList.remove('ring-2', 'ring-primary');
          }
        });
      }

      // Add navigation event listeners
      const prevBtn = document.getElementById('creative-modal-prev-btn');
      const nextBtn = document.getElementById('creative-modal-next-btn');
      
      if (prevBtn) {
        prevBtn.removeEventListener('click', showPreviousMedia);
        prevBtn.addEventListener('click', showPreviousMedia);
      }
      
      if (nextBtn) {
        nextBtn.removeEventListener('click', showNextMedia);
        nextBtn.addEventListener('click', showNextMedia);
      }

      // Keyboard navigation
      function handleKeydown(e) {
        if (modal && !modal.classList.contains('hidden')) {
          if (e.key === 'ArrowLeft') {
            e.preventDefault();
            showPreviousMedia();
          } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            showNextMedia();
          }
        }
      }

      // Remove existing keydown listener and add new one
      document.removeEventListener('keydown', handleKeydown);
      document.addEventListener('keydown', handleKeydown);

      // Populate personal details from personalInfo map in a structured way
      modalPersonal.innerHTML = '';
      if (currentCreative.personalInfo && Object.keys(currentCreative.personalInfo).length > 0) {
        Object.entries(currentCreative.personalInfo).forEach(([key, value]) => {
          if (value !== null && value !== undefined && value !== '') {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'flex gap-2 border-b border-default/10 py-1 px-0.5 items-start';
            // Format the key to be more readable (camelCase to Title Case)
            const formattedLabel = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            // Detect if value is a URL
            const urlPattern = /^(https?:\/\/|www\.)[\w\-]+(\.[\w\-]+)+([\w.,@?^=%&:/~+#\-]*[\w@?^=%&/~+#\-])?$/;
            let valueHtml = '';
            if (typeof value === 'string' && urlPattern.test(value.trim())) {
              let url = value.trim();
              if (!/^https?:\/\//.test(url)) url = 'https://' + url;
              valueHtml = `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-primary underline break-all max-w-[12rem] text-right block">${value}</a>`;
            } else {
              valueHtml = `<span class="text-default text-right break-words break-all whitespace-pre-line max-w-[12rem] block">${value}</span>`;
            }
            fieldDiv.innerHTML = `
              <span class="font-medium text-default/70 flex-shrink-0">${formattedLabel}:</span>
              ${valueHtml}
            `;
            modalPersonal.appendChild(fieldDiv);
          }
        });
      }
      // If no personalInfo data, show a message
      if (modalPersonal.children.length === 0) {
        const noDataDiv = document.createElement('div');
        noDataDiv.className = 'min-w-0 text-center col-span-2';
        noDataDiv.innerHTML = `
          <span class="text-sm text-default/60 block">No personal information available</span>
        `;
        modalPersonal.appendChild(noDataDiv);
      }

      // Show modal with animation
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
      modal.dataset.currentCreativeId = id; // Store current creative ID
      modal.dataset.pdfUrl = pdfUrl || ''; // Store PDF URL
      document.body.style.overflow = 'hidden';
      
      // Animate modal content
      setTimeout(() => {
        if (modalContent) {
          modalContent.classList.remove('scale-95', 'opacity-0');
          modalContent.classList.add('scale-100', 'opacity-100');
        }
      }, 10);
    }

    function closeCreativeModal() {
      const modal = document.getElementById('creative-modal');
      const modalContent = document.getElementById('creative-modal-content');
      
      // Animate modal content out
      if (modalContent) {
        modalContent.classList.add('scale-95', 'opacity-0');
        modalContent.classList.remove('scale-100', 'opacity-100');
      }
      
      // Delay hiding the modal to allow animation to complete
      setTimeout(() => {
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = 'auto';
      }, 300);
    }

    async function downloadCreativePortfolio() {
      const downloadBtn = document.getElementById('creative-download-portfolio-btn');
      const portfolioText = downloadBtn.querySelector('.creative-portfolio-text');
      const portfolioSpinner = downloadBtn.querySelector('.creative-portfolio-spinner');
      
      if (!downloadBtn) return;
      
      const originalText = portfolioText.textContent;
      downloadBtn.disabled = true;
      portfolioText.textContent = 'Loading Portfolio...';
      portfolioSpinner.classList.remove('hidden');
      
      try {
        // Get current creative ID and PDF URL from stored data
        const modal = document.getElementById('creative-modal');
        const currentCreativeId = modal ? modal.dataset.currentCreativeId : null;
        const storedPdfUrl = modal ? modal.dataset.pdfUrl : null;
        
        if (!currentCreativeId) {
          throw new Error('No creative ID found');
        }

        console.log('PDF URL check:', storedPdfUrl);

        // Use stored PDF URL if available, otherwise try Firebase
        let pdfUrl = storedPdfUrl;
        
        if (!pdfUrl || pdfUrl.trim() === '') {
          console.log('No stored PDF URL, trying Firebase...');
          pdfUrl = await getCreativePdfUrl(currentCreativeId);
        }
        
        if (pdfUrl && pdfUrl.trim() !== '') {
          console.log('Opening PDF URL:', pdfUrl);
          // Create a temporary link and trigger download
          const link = document.createElement('a');
          link.href = pdfUrl;
          link.download = ''; // Let the browser determine the filename from the URL
          link.target = '_blank'; // Open in new tab as fallback
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } else {
          // Show user-friendly message
          console.log('No PDF URL found');
          alert('Portfolio PDF not available for this creative.');
        }
        
      } catch (error) {
        console.error('Error downloading portfolio:', error);
        alert('Unable to download portfolio. Please try again later.');
      } finally {
        downloadBtn.disabled = false;
        portfolioText.textContent = originalText;
        portfolioSpinner.classList.add('hidden');
      }
    }

    // Function to get creative PDF URL from Firebase
    async function getCreativePdfUrl(creativeId) {
      try {
        // Import Firebase functions dynamically
        const { doc, getDoc } = await import('firebase/firestore');
        const { db } = await import('~/lib/firebase');
        
        const creativeRef = doc(db, 'creatives', creativeId);
        const creativeDoc = await getDoc(creativeRef);
        
        if (creativeDoc.exists()) {
          const data = creativeDoc.data();
          return data.pdfUrl || null;
        }
        
        return null;
      } catch (error) {
        console.error('Error fetching creative PDF URL:', error);
        throw error;
      }
    }

    // Event listeners
    document.getElementById('close-creative-modal')?.addEventListener('click', closeCreativeModal);
    document.getElementById('creative-download-portfolio-btn')?.addEventListener('click', downloadCreativePortfolio);

    // Close modal when clicking outside
    document.getElementById('creative-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'creative-modal') {
        closeCreativeModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('creative-modal');
        if (modal && !modal.classList.contains('hidden')) {
          closeCreativeModal();
        }
      }
    });

    // Make functions globally available
    window.openCreativeModal = openCreativeModal;
    window.closeCreativeModal = closeCreativeModal;
    window.downloadCreativePortfolio = downloadCreativePortfolio;
  }
</script>

<style>
  .modal.is-open {
    @apply block;
  }
</style>
