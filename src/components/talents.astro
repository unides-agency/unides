---
import ContentSection from "~/components/content-section.astro";
import TalentModalComponent from "~/components/talent-modal-component.astro";
import { getTalents } from "~/lib/talents";

// Fetch talents from Firebase
let talents = [];
try {
  const allTalents = await getTalents();
  // Filter to only show enabled talents
  talents = allTalents.filter(talent => talent.enabled == true);
  console.log(`Loaded ${talents.length} enabled talents from Firebase`);
} catch (error) {
  console.error('Failed to load talents:', error);
}
---

<ContentSection title="Talents" id="talents">
  <Fragment slot="lead">
    Discover our <span class="text-primary">exceptional talents</span> ready to bring your vision to life.
  </Fragment>

  {talents.length === 0 ? (
    <div class="text-center py-8">
      <p class="text-default/60">No talents available at the moment. Please check back later.</p>
    </div>
  ) : (
    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
      {talents.map((talent) => (
        <div class="talent-card bg-offset rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105">
          <div class="aspect-[2/3] bg-default/20 flex items-center justify-center relative">
            {talent.image && talent.image.trim() !== "" ? (
              <img
                src={talent.image}
                alt={`${talent.name} - ${talent.specialty}`}
                class="w-full h-full object-cover"
                loading={talent.id <= 4 ? "eager" : "lazy"}
                fetchpriority={talent.id <= 2 ? "high" : "auto"}
                width="200"
                height="300"
              />
            ) : (
              <span class="text-default/60 text-xs">Photo Coming Soon</span>
            )}
            
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-2 text-white">
              <div class="space-y-1">
                {/* Name - Featured prominently */}
                <div class="text-white">
                  <h3 class="font-bold text-sm leading-tight">{talent.name}</h3>
                </div>
                
                {/* Location and Top Specialty Only */}
                <div class="flex flex-wrap gap-1 items-center min-w-0">
                  {talent.location && (
                    <div class="bg-black/40 text-white text-xs py-0.5 px-1.5 rounded-full backdrop-blur-sm flex items-center min-w-0">
                      <span class="mr-1">üìç</span>{talent.location}
                    </div>
                  )}
                  {talent.birth && (
                    <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm min-w-0" title="Birth">
                      üéÇ {talent.birth}
                    </span>
                  )}
                  {talent.specialties && talent.specialties.length > 0 && (
                    <span class="bg-primary/80 text-white text-xs py-0.5 px-1.5 rounded-full min-w-0">
                      {talent.specialties[0].trim()}
                    </span>
                  )}
                </div>
                
                {/* Personal Details - Compact */}
                <div class="flex flex-wrap gap-1 min-w-0">
                  {talent.height && (
                    <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm min-w-0" title="Height">
                      üìè {talent.height}cm
                    </span>
                  )}
                  {talent.shoeSize && (
                    <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm min-w-0" title="Shoe Size">
                      üëü {talent.shoeSize}
                    </span>
                  )}
                  {talent.dressSize && (
                    <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm min-w-0" title="Dress Size">
                      üëó {talent.dressSize}
                    </span>
                  )}
                  {talent.eyeColor && (
                    <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm min-w-0" title="Eye Color">
                      üëÅÔ∏è {talent.eyeColor}
                    </span>
                  )}
                  {talent.hairColor && (
                    <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm min-w-0" title="Hair Color">
                      üíá {talent.hairColor}
                    </span>
                  )}
                </div>
              </div>
            </div>
          </div>
          <div class="p-3">
            <div class="mb-2">
              {/* Skills/Experience Tags */}
              <div class="flex flex-wrap gap-1 min-w-0">
                {talent.skills && talent.skills.split(',').map((skill) => (
                  <span class="text-xs px-2 py-0.5 bg-primary/20 text-primary rounded-full hover:bg-primary/30 transition-colors min-w-0">
                    {skill.trim()}
                  </span>
                ))}
              </div>
            </div>
            
            <button
              class="view-profile-btn w-full bg-primary text-white px-3 py-1.5 rounded-md hover:bg-primary/80 hover:bg-purple-600 focus:ring-2 focus:ring-purple-400 focus:outline-none transition-all duration-300 text-xs font-medium relative overflow-hidden group disabled:opacity-50 disabled:cursor-not-allowed"
              data-talent-id={talent.id}
              data-talent-name={talent.name}
              data-talent-specialties={talent.specialties ? talent.specialties.join(', ') : talent.specialty || ''}
              data-talent-description={talent.description}
              data-talent-image={talent.image || ""}
              data-talent-location={talent.location || ""}
              data-talent-birth={talent.birth || ""}
              data-talent-age={talent.age || ""}
              data-talent-height={talent.height || ""}
              data-talent-eyecolor={talent.eyeColor || ""}
              data-talent-haircolor={talent.hairColor || ""}
              data-talent-shoesize={talent.shoeSize || ""}
              data-talent-dresssize={talent.dressSize || ""}
              data-talent-imgs={talent.imgs ? JSON.stringify(talent.imgs) : ""}
              data-talent-portfoliourl={talent.portfolioUrl || talent.pdfUrl || ""}
            >
              <span class="relative z-10 group-hover:translate-x-1 transition-transform duration-300 inline-flex items-center min-w-0">
                <span class="loading-text">View Profile</span>
                <span class="loading-spinner hidden animate-spin ml-2">‚è≥</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 ml-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300 arrow-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </span>
              <span class="absolute inset-0 bg-gradient-to-r from-purple-600 to-primary transform scale-x-0 group-hover:scale-x-100 origin-left transition-transform duration-300"></span>
            </button>
          </div>
        </div>
      ))}
    </div>
  )}
</ContentSection>

<!-- Inject talents data for modal JS -->
<script type="application/json" id="talents-data">{JSON.stringify(talents)}</script>

<!-- Include the extracted modal component -->
<TalentModalComponent />

<script>
  // Set up view profile button event listeners
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up talent modal listeners');
    
    var viewProfileBtns = document.querySelectorAll('.view-profile-btn');
    console.log('Found', viewProfileBtns.length, 'view profile buttons');
    
    for (var i = 0; i < viewProfileBtns.length; i++) {
      viewProfileBtns[i].addEventListener('click', function(e) {
        e.preventDefault();
        var btn = e.currentTarget;
        var id = btn.getAttribute('data-talent-id');
        var name = btn.getAttribute('data-talent-name');
        var specialties = btn.getAttribute('data-talent-specialties');
        var description = btn.getAttribute('data-talent-description');
        var image = btn.getAttribute('data-talent-image');
        var location = btn.getAttribute('data-talent-location');
        var birth = btn.getAttribute('data-talent-birth');
        var age = btn.getAttribute('data-talent-age');
        var height = btn.getAttribute('data-talent-height');
        var eyeColor = btn.getAttribute('data-talent-eyecolor');
        var hairColor = btn.getAttribute('data-talent-haircolor');
        var shoeSize = btn.getAttribute('data-talent-shoesize');
        var dressSize = btn.getAttribute('data-talent-dresssize');
        var imgs = btn.getAttribute('data-talent-imgs');
        var portfolioUrl = btn.getAttribute('data-talent-portfoliourl');
        
        // Parse imgs JSON string back to array
        var imgsArray = [];
        if (imgs && imgs !== "") {
          try {
            imgsArray = JSON.parse(imgs);
          } catch (e) {
            console.error('Error parsing imgs:', e);
          }
        }
        
        console.log('Opening modal for talent:', { id, name, specialties, description, image, location, birth, age, height, eyeColor, hairColor, shoeSize, dressSize, imgsArray, portfolioUrl });
        
        // Set global event for openTalentModal
        window.event = e;
        
        // Call the modal function
        if (typeof window.openTalentModal === 'function') {
          window.openTalentModal(id, name, specialties, description, image, location, birth, age, height, eyeColor, hairColor, shoeSize, dressSize, imgsArray, portfolioUrl);
        } else {
          console.error('openTalentModal function not found');
        }
      });
    }
  });
</script>

<style>
  /* Fix flex wrapping issues by ensuring flex children have min-width: 0 */
  .flex > * {
    min-width: 0;
  }
  
  .flex-wrap > * {
    min-width: 0;
  }
  
  .inline-flex > * {
    min-width: 0;
  }
  
  /* Specific fixes for talent card flex containers */
  .talent-card .flex > * {
    min-width: 0;
    flex-shrink: 1;
  }
  
  .talent-card .flex-wrap > * {
    min-width: 0;
    flex-shrink: 1;
  }
  
  /* Responsive flex fixes */
  @media (min-width: 768px) {
    .md\:flex > * {
      min-width: 0;
    }
  }
  
  @media (min-width: 1024px) {
    .lg\:flex > * {
      min-width: 0;
    }
    
    .lg\:flex-row > * {
      min-width: 0;
    }
    
    .lg\:flex-col > * {
      min-width: 0;
    }
  }
  
  /* Grid fixes for similar issues */
  .grid > * {
    min-width: 0;
  }
  
  /* Specific button flex fixes */
  .view-profile-btn .inline-flex > * {
    min-width: 0;
    flex-shrink: 0; /* Prevent button content from shrinking */
  }
  
  /* Tag and badge flex fixes */
  .flex.gap-1 > span,
  .flex.flex-wrap > span {
    min-width: 0;
    flex-shrink: 0; /* Prevent tags from shrinking too much */
  }

  /* Performance-optimized animations */
  .talent-card {
    transition-duration: var(--animation-duration, 0.3s);
    transition-timing-function: var(--animation-easing, cubic-bezier(0.4, 0, 0.2, 1));
  }

  .view-profile-btn {
    transition-duration: var(--animation-duration, 0.3s);
    transition-timing-function: var(--animation-easing, cubic-bezier(0.4, 0, 0.2, 1));
  }

  /* Optimizations for better LCP */
  .talent-card img {
    content-visibility: auto;
    contain-intrinsic-size: 200px 300px;
  }

  /* Prevent layout shifts for better CLS */
  .talent-card {
    contain: layout style;
  }

  .talent-card .aspect-\[2\/3\] {
    min-height: 300px; /* Explicit height to prevent CLS */
  }

  /* Reduce motion for users who prefer it */
  @media (prefers-reduced-motion: reduce) {
    .talent-card,
    .view-profile-btn {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      transition-delay: 0s !important;
    }
    
    .talent-card:hover {
      transform: none !important;
    }
  }

  /* Performance mode styles */
  .performance-mode .talent-card {
    transition-duration: 0.1s !important;
    will-change: auto !important;
  }

  .performance-mode .talent-card:hover {
    transform: scale(1.01) !important;
  }

  /* Critical CSS for above-the-fold content */
  .talent-card:nth-child(-n+4) {
    contain: none; /* Allow critical cards to render faster */
  }

  .talent-card:nth-child(-n+4) img {
    loading: eager;
    fetchpriority: high;
  }
</style>
