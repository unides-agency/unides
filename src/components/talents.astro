---
import ContentSection from "~/components/content-section.astro";
import TalentModalComponent from "~/components/talent-modal-component.astro";
import { getTalents } from "~/lib/talents";
import { getCreatives } from "~/lib/creatives";

// Fetch talents and creatives from Firebase
let talents = [];
let creatives = [];
let allPeople = [];
try {
  const allTalents = await getTalents();
  const allCreatives = await getCreatives();
  
  // Filter for enabled items only
  const enabledTalents = allTalents.filter(talent => talent.enabled == true);
  const enabledCreatives = allCreatives.filter(creative => creative.enabled == true);
  
  // Add fallback specialty if missing
  talents = enabledTalents.map(t => ({ 
    ...t, 
    type: 'Talent',
    specialty: t.specialty || 'Model'
  }));
  creatives = enabledCreatives.map(c => ({ 
    ...c, 
    type: 'Creative',
    specialty: c.specialty || 'Creative'
  }));
  
  allPeople = [...talents, ...creatives];
  
} catch (error) {
  console.error('Failed to load talents or creatives:', error);
}

// Filtering logic
const FILTERS = [
  { label: 'All', value: 'ALL' },
  { label: 'Models', value: 'Model' },
  { label: 'Creatives', value: 'Creative' },
  // Add more filters as needed, e.g., Actress, Model, etc.
];
let selectedFilter = 'ALL';

function getFilteredPeople() {
  if (selectedFilter === 'ALL') return allPeople;
  if (selectedFilter === 'Model') {
    return allPeople.filter(person => person.specialty === 'Model' || (person.specialties && person.specialties.includes('Model')));
  }
  return allPeople.filter(person => person.type === selectedFilter);
}

function getCount(type) {
  if (type === 'ALL') return allPeople.length;
  if (type === 'Model') {
    return allPeople.filter(person => person.specialty === 'Model' || (person.specialties && person.specialties.includes('Model'))).length;
  }
  return allPeople.filter(person => person.type === type).length;
}
---

<ContentSection title="talents" id="talents" sectionType="talents">

  {/* Filter Buttons */}
  <div class="flex flex-wrap gap-2 mb-6 justify-center" id="filter-buttons">
    {FILTERS.map(filter => (
      <button
        class="filter-btn px-4 py-1 rounded-full border border-default/30 bg-white/20 hover:bg-primary/10 transition text-sm font-medium flex items-center gap-2"
        type="button"
        data-filter={filter.value}
      >
        {filter.label}
        <span class="filter-count-badge">{getCount(filter.value)}</span>
      </button>
    ))}
  </div>

  {allPeople.length === 0 ? (
    <div class="text-center py-8">
      <p class="text-default/60">No profiles available at the moment. Please check back later.</p>
    </div>
  ) : (
    <>
      {/* Desktop Grid Layout */}
      <div class="hidden md:grid gap-4 md:grid-cols-2 lg:grid-cols-4" id="people-grid-desktop">
        {allPeople.map((person) => (
          <div
            class="talent-card group bg-offset rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer"
            data-type={person.type}
            data-talent-id={person.id}
            data-talent-name={person.name}
            data-talent-specialties={person.specialties ? person.specialties.join(', ') : person.specialty}
            data-talent-description={person.description}
            data-talent-image={person.image}
            data-talent-location={person.location}
            data-talent-birth={person.birth}
            data-talent-age={person.age}
            data-talent-height={person.height}
            data-talent-eyecolor={person.eyeColor}
            data-talent-haircolor={person.hairColor}
            data-talent-shoesize={person.shoeSize}
            data-talent-dresssize={person.dressSize}
            data-talent-imgs={person.imgs ? JSON.stringify(person.imgs) : ''}
            data-talent-portfoliourl={person.portfolioUrl || ''}
            data-talent-pdfurl={person.pdfUrl || ''}
            data-talent-personalinfo={person.personalInfo ? JSON.stringify(person.personalInfo) : ''}
          >
            <div class="aspect-[2/3] bg-default/20 flex items-center justify-center relative">
              {person.image && person.image.trim() !== "" ? (
                <img
                  src={person.image}
                  alt={`${person.name} - ${person.specialty}`}
                  class="w-full h-full object-cover"
                  width="280"
                  height="420"
                  loading="lazy"
                  decoding="async"
                />
              ) : (
                <span class="text-default/60 text-xs">Photo Coming Soon</span>
              )}
              <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent pt-2 px-4 pb-4 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <div class="space-y-1">
                  <div class="text-white">
                    <h3 class="talent-name leading-tight">{person.name}</h3>
                  </div>
                  <div class="flex flex-wrap gap-1 items-center min-w-0">
                    {person.location && (
                      <div class="location-tag bg-black/40 text-white text-xs py-0.5 px-1.5 rounded-full backdrop-blur-sm flex items-center min-w-0">
                        <span class="mr-1">üìç</span>{person.location}
                      </div>
                    )}
                  </div>
                  <div class="flex flex-wrap gap-1 items-center">
                    {person.specialties ? person.specialties.map(specialty => (
                      <span class="specialty-tag bg-black/40 text-white text-xs py-0.5 px-1.5 rounded-full backdrop-blur-sm">
                        {specialty}
                      </span>
                    )) : (
                      <span class="specialty-tag bg-black/40 text-white text-xs py-0.5 px-1.5 rounded-full backdrop-blur-sm">
                        {person.specialty}
                      </span>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* Mobile Grid Layout */}
      <div class="md:hidden">
        <div class="grid grid-cols-2 gap-4" id="people-grid-mobile">
          {allPeople.map((person, index) => (
            <div
              class="talent-card group bg-offset rounded-lg overflow-hidden shadow-lg cursor-pointer"
              data-type={person.type}
              data-talent-id={person.id}
              data-talent-name={person.name}
              data-talent-specialties={person.specialties ? person.specialties.join(', ') : person.specialty}
              data-talent-description={person.description}
              data-talent-image={person.image}
              data-talent-location={person.location}
              data-talent-birth={person.birth}
              data-talent-age={person.age}
              data-talent-height={person.height}
              data-talent-eyecolor={person.eyeColor}
              data-talent-haircolor={person.hairColor}
              data-talent-shoesize={person.shoeSize}
              data-talent-dresssize={person.dressSize}
              data-talent-imgs={person.imgs ? JSON.stringify(person.imgs) : ''}
              data-talent-portfoliourl={person.portfolioUrl || ''}
              data-talent-pdfurl={person.pdfUrl || ''}
              data-talent-personalinfo={person.personalInfo ? JSON.stringify(person.personalInfo) : ''}
            >
              <div class="aspect-[3/4] bg-default/20 flex items-center justify-center relative">
                {person.image && person.image.trim() !== "" ? (
                  <img
                    src={person.image}
                    alt={`${person.name} - ${person.specialty}`}
                    class="w-full h-full object-cover"
                    width="180"
                    height="240"
                    loading="lazy"
                    decoding="async"
                  />
                ) : (
                  <span class="text-default/60 text-xs">Photo Coming Soon</span>
                )}
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent pt-2 px-4 pb-4 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <div class="space-y-1">
                    <div class="text-white">
                      <h3 class="talent-name leading-tight">{person.name}</h3>
                    </div>
                    <div class="flex flex-wrap gap-1 items-center min-w-0">
                      {person.location && (
                        <div class="location-tag bg-black/40 text-white text-xs py-0.5 px-1 rounded-full backdrop-blur-sm flex items-center min-w-0">
                          <span class="mr-0.5 text-xs">üìç</span><span class="text-xs">{person.location}</span>
                        </div>
                      )}
                    </div>
                    <div class="flex flex-wrap gap-1 items-center">
                      {person.specialties ? person.specialties.slice(0, 3).map(specialty => (
                        <span class="specialty-tag bg-black/40 text-white text-xs py-0.5 px-1.5 rounded-full backdrop-blur-sm">
                          {specialty}
                        </span>
                      )) : (
                        <span class="specialty-tag bg-black/40 text-white text-xs py-0.5 px-1.5 rounded-full backdrop-blur-sm">
                          {person.specialty}
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </>
  )}
</ContentSection>

<!-- Inject data for client-side filtering -->
<script type="application/json" id="people-data">{JSON.stringify(allPeople)}</script>

<!-- Include the extracted modal component -->
<TalentModalComponent />

<script>
  // Client-side filtering functionality
  document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const desktopCards = document.querySelectorAll('#people-grid-desktop .talent-card');
    const mobileCards = document.querySelectorAll('#people-grid-mobile .talent-card');
    let currentFilter = 'ALL';

    // Set initial active state
    updateActiveButton('ALL');

    // Ensure initial visibility of cards
    filterCards('ALL');

    // Set up event delegation for card clicks
    setupClickHandlers();
    
    // Retry setup after modal loads (needed for async component loading)
    setTimeout(() => {
      if (typeof window.openTalentModal === 'function') {
        setupClickHandlers();
      }
    }, 500);

    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        const filter = this.getAttribute('data-filter');
        currentFilter = filter;

        // Update active button state
        updateActiveButton(filter);

        // Filter cards for both desktop and mobile
        filterCards(filter);
      });
    });

    function updateActiveButton(activeFilter) {
      filterButtons.forEach(btn => {
        const btnFilter = btn.getAttribute('data-filter');
        if (btnFilter === activeFilter) {
          // Apply selected filter styling
          btn.style.borderWidth = '2px';
          btn.style.borderColor = 'white';
          btn.style.fontWeight = '800';
          btn.style.backgroundColor = 'var(--color-primary)';
          btn.style.color = 'white';
          btn.classList.remove('bg-white/20');
        } else {
          // Apply unselected filter styling
          btn.style.borderWidth = '';
          btn.style.borderColor = '';
          btn.style.fontWeight = '';
          btn.style.backgroundColor = '';
          btn.style.color = '';
          btn.classList.add('bg-white/20');
        }
      });
    }

    function filterCards(filter) {
      // Filter desktop cards
      desktopCards.forEach(card => {
        const cardType = card.getAttribute('data-type');
        const cardSpecialties = card.getAttribute('data-talent-specialties');
        let shouldShow = false;
        
        if (filter === 'ALL') {
          shouldShow = true;
        } else if (filter === 'Model') {
          shouldShow = cardSpecialties && cardSpecialties.includes('Model');
        } else {
          shouldShow = cardType === filter;
        }
        
        if (shouldShow) {
          card.style.display = '';
          card.classList.add('fade-in');
        } else {
          card.style.display = 'none';
          card.classList.remove('fade-in');
        }
      });

      // Filter mobile cards
      mobileCards.forEach(card => {
        const cardType = card.getAttribute('data-type');
        const cardSpecialties = card.getAttribute('data-talent-specialties');
        let shouldShow = false;
        
        if (filter === 'ALL') {
          shouldShow = true;
        } else if (filter === 'Model') {
          shouldShow = cardSpecialties && cardSpecialties.includes('Model');
        } else {
          shouldShow = cardType === filter;
        }
        
        if (shouldShow) {
          card.style.display = '';
          card.classList.add('fade-in');
        } else {
          card.style.display = 'none';
          card.classList.remove('fade-in');
        }
      });
    }

    // Helper function to extract talent data from a card element
    function getTalentDataFromCard(card) {
      var imgs = card.getAttribute('data-talent-imgs');
      var personalInfo = card.getAttribute('data-talent-personalinfo');
      
      var imgsArray = [];
      if (imgs && imgs !== "") {
        try { imgsArray = JSON.parse(imgs); } catch (e) {}
      }
      
      var personalInfoObj = {};
      if (personalInfo && personalInfo !== "") {
        try { personalInfoObj = JSON.parse(personalInfo); } catch (e) {}
      }
      
      return {
        id: card.getAttribute('data-talent-id'),
        name: card.getAttribute('data-talent-name'),
        specialties: card.getAttribute('data-talent-specialties'),
        description: card.getAttribute('data-talent-description'),
        image: card.getAttribute('data-talent-image'),
        location: card.getAttribute('data-talent-location'),
        birth: card.getAttribute('data-talent-birth'),
        age: card.getAttribute('data-talent-age'),
        height: card.getAttribute('data-talent-height'),
        eyeColor: card.getAttribute('data-talent-eyecolor'),
        hairColor: card.getAttribute('data-talent-haircolor'),
        shoeSize: card.getAttribute('data-talent-shoesize'),
        dressSize: card.getAttribute('data-talent-dresssize'),
        imgsArray: imgsArray,
        portfolioUrl: card.getAttribute('data-talent-portfoliourl'),
        pdfUrl: card.getAttribute('data-talent-pdfurl'),
        personalInfoObj: personalInfoObj
      };
    }

    // Event delegation for card clicks - single listener on parent containers
    function setupEventDelegation() {
      const desktopGrid = document.getElementById('people-grid-desktop');
      const mobileGrid = document.getElementById('people-grid-mobile');
      
      function handleGridClick(e) {
        const card = e.target.closest('.talent-card');
        if (!card) return;
        
        e.preventDefault();
        const data = getTalentDataFromCard(card);
        
        if (typeof window.openTalentModal === 'function') {
          window.openTalentModal(
            data.id, data.name, data.specialties, data.description, data.image,
            data.location, data.birth, data.age, data.height, data.eyeColor,
            data.hairColor, data.shoeSize, data.dressSize, data.imgsArray,
            data.portfolioUrl, data.pdfUrl, data.personalInfoObj
          );
        }
      }
      
      if (desktopGrid) desktopGrid.addEventListener('click', handleGridClick);
      if (mobileGrid) mobileGrid.addEventListener('click', handleGridClick);
    }

    // Legacy function for backward compatibility
    function setupClickHandlers() {
      setupEventDelegation();
    }
  });
</script>

<style>
  /* Fix flex wrapping issues by ensuring flex children have min-width: 0 */
  .flex > * {
    min-width: 0;
  }
  
  .flex-wrap > * {
    min-width: 0;
  }
  
  .inline-flex > * {
    min-width: 0;
  }
  
  /* Specific fixes for talent card flex containers */
  .talent-card .flex > * {
    min-width: 0;
    flex-shrink: 1;
  }
  
  .talent-card .flex-wrap > * {
    min-width: 0;
    flex-shrink: 1;
  }
  
  /* Responsive flex fixes */
  @media (min-width: 768px) {
    .md\:flex > * {
      min-width: 0;
    }
  }
  
  @media (min-width: 1024px) {
    .lg\:flex > * {
      min-width: 0;
    }
    
    .lg\:flex-row > * {
      min-width: 0;
    }
    
    .lg\:flex-col > * {
      min-width: 0;
    }
  }
  
  /* Grid fixes for similar issues */
  .grid > * {
    min-width: 0;
  }
  
  /* Specific button flex fixes */
  .view-profile-btn .inline-flex > * {
    min-width: 0;
    flex-shrink: 0; /* Prevent button content from shrinking */
  }
  
  /* Tag and badge flex fixes */
  .flex.gap-1 > span,
  .flex.flex-wrap > span {
    min-width: 0;
    flex-shrink: 0; /* Prevent tags from shrinking too much */
  }

  /* Performance-optimized animations */
  .talent-card {
    transition-duration: var(--animation-duration, 0.3s);
    transition-timing-function: var(--animation-easing, cubic-bezier(0.4, 0, 0.2, 1));
  }

  .view-profile-btn {
    transition-duration: var(--animation-duration, 0.3s);
    transition-timing-function: var(--animation-easing, cubic-bezier(0.4, 0, 0.2, 1));
  }

  /* Optimizations for better LCP */
  .talent-card img {
    content-visibility: auto;
    contain-intrinsic-size: 200px 300px;
  }

  /* Prevent layout shifts for better CLS */
  .talent-card {
    contain: layout style;
  }

  .talent-card .aspect-\[2\/3\] {
    min-height: 300px; /* Explicit height to prevent CLS */
  }

  /* Reduce motion for users who prefer it */
  @media (prefers-reduced-motion: reduce) {
    .talent-card,
    .view-profile-btn {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      transition-delay: 0s !important;
    }
    
    .talent-card:hover {
      transform: none !important;
    }
  }

  /* Performance mode styles */
  .performance-mode .talent-card {
    transition-duration: 0.1s !important;
    will-change: auto !important;
  }

  .performance-mode .talent-card:hover {
    transform: scale(1.01) !important;
  }

  /* Critical CSS for above-the-fold content */
  .talent-card:nth-child(-n+4) {
    contain: none; /* Allow critical cards to render faster */
  }

  .talent-card:nth-child(-n+4) img {
    loading: eager;
    fetchpriority: high;
  }

  /* Filter button animations */
  .filter-btn {
    transition: all 0.3s ease;
    border-width: 1px; /* Default border width */
  }

  .filter-btn:hover {
    transform: translateY(-1px);
  }

  /* Active/selected filter button styling */
  .filter-btn.active,
  .filter-btn.bg-primary {
    border-width: 2px; /* Thicker border for selected state */
    border-color: white; /* White stroke for selected state */
    font-weight: 800 !important; /* Extra bold text for selected state */
    background-color: var(--color-primary) !important; /* Purple fill for selected state */
    color: white !important; /* White text for contrast */
  }

  /* Green oval count badge */
  .filter-count-badge {
    background-color: #D9FD12; /* Green/lime color */
    color: #0A353A; /* Dark teal text for contrast */
    padding: 0.25rem 0.625rem;
    border-radius: 9999px; /* Full rounded/oval shape */
    font-size: 0.75rem;
    font-weight: 700; /* Bold font weight */
    min-width: 1.5rem;
    text-align: center;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  /* Card fade animation */
  .talent-card {
    transition: all 0.3s ease;
  }

  .fade-in {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Mobile Grid Styles */
  @media (max-width: 767px) {
    #people-grid-mobile {
      /* Removed padding since main container already has px-4 (16px) */
    }
    
    #people-grid-mobile .talent-card {
      transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    }
    
    #people-grid-mobile .talent-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    #people-grid-mobile .aspect-\[3\/4\] {
      min-height: 240px; /* Increased from 200px by 20% (200 * 1.2 = 240px) */
    }
  }

  /* Desktop grid visibility fix */
  @media (min-width: 768px) {
    #people-grid-desktop {
      display: grid !important;
    }
  }

  @media (max-width: 767px) {
    #people-grid-desktop {
      display: none !important;
    }
  }
</style>
