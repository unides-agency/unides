---
import Image from "astro/components/Image.astro";
import ContentSection from "~/components/content-section.astro";
import TalentModalComponent from "~/components/talent-modal-component.astro";
import { getTalents } from "~/lib/talents";
import { getCreatives } from "~/lib/creatives";

// Fetch talents and creatives from Firebase
let talents = [];
let creatives = [];
let allPeople = [];
try {
  const allTalents = await getTalents();
  const allCreatives = await getCreatives();
  console.log('üîç DEBUG - Raw fetched talents:', allTalents);
  console.log('üîç DEBUG - Raw fetched creatives:', allCreatives);
  
  // Check for missing required fields
  allTalents.forEach((talent, index) => {
    console.log(`üîç Talent ${index + 1} (${talent.name}):`, {
      id: talent.id,
      name: talent.name,
      specialty: talent.specialty || 'MISSING',
      enabled: talent.enabled,
      hasImage: !!talent.image,
      hasDescription: !!talent.description
    });
  });
  
  allCreatives.forEach((creative, index) => {
    console.log(`üîç Creative ${index + 1} (${creative.name}):`, {
      id: creative.id,
      name: creative.name,
      specialty: creative.specialty || 'MISSING',
      enabled: creative.enabled,
      hasImage: !!creative.image,
      hasDescription: !!creative.description
    });
  });
  
  // Filter for enabled items only
  const enabledTalents = allTalents.filter(talent => talent.enabled == true);
  const enabledCreatives = allCreatives.filter(creative => creative.enabled == true);
  console.log(`üîç DEBUG - Enabled talents: ${enabledTalents.length}/${allTalents.length}`);
  console.log(`üîç DEBUG - Enabled creatives: ${enabledCreatives.length}/${allCreatives.length}`);
  
  // Add fallback specialty if missing
  talents = enabledTalents.map(t => ({ 
    ...t, 
    type: 'Talent',
    specialty: t.specialty || 'Model' // Fallback if missing
  }));
  creatives = enabledCreatives.map(c => ({ 
    ...c, 
    type: 'Creative',
    specialty: c.specialty || 'Creative' // Fallback if missing
  }));
  
  allPeople = [...talents, ...creatives];
  console.log('üîç DEBUG - Final combined people:', allPeople);
  console.log(`üîç DEBUG - Total people to display: ${allPeople.length}`);
  
} catch (error) {
  console.error('‚ùå Failed to load talents or creatives:', error);
}

// Filtering logic
const FILTERS = [
  { label: 'All', value: 'ALL' },
  { label: 'Talent', value: 'Talent' },
  { label: 'Creative', value: 'Creative' },
  // Add more filters as needed, e.g., Actress, Model, etc.
];
let selectedFilter = 'ALL';

function getFilteredPeople() {
  if (selectedFilter === 'ALL') return allPeople;
  return allPeople.filter(person => person.type === selectedFilter);
}

function getCount(type) {
  if (type === 'ALL') return allPeople.length;
  return allPeople.filter(person => person.type === type).length;
}
---

<ContentSection title="Talent" id="talents">
  <Fragment slot="lead">
    Discover our <span class="text-primary">exceptional talent & creative pool</span> ready to bring your vision to life.
  </Fragment>

  {/* Filter Buttons */}
  <div class="flex flex-wrap gap-2 mb-6 justify-center" id="filter-buttons">
    {FILTERS.map(filter => (
      <button
        class="filter-btn px-4 py-1 rounded-full border border-default/30 bg-white/20 hover:bg-primary/10 transition text-sm font-medium flex items-center gap-2"
        type="button"
        data-filter={filter.value}
      >
        {filter.label}
        <span class="filter-count-badge">{getCount(filter.value)}</span>
      </button>
    ))}
  </div>

  {allPeople.length === 0 ? (
    <div class="text-center py-8">
      <p class="text-default/60">No profiles available at the moment. Please check back later.</p>
    </div>
  ) : (
    <>
      {/* Desktop Grid Layout */}
      <div class="hidden md:grid gap-4 md:grid-cols-2 lg:grid-cols-4" id="people-grid-desktop">
        {allPeople.map((person) => (
          <div
            class="talent-card bg-offset rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer"
            data-type={person.type}
            data-talent-id={person.id}
            data-talent-name={person.name}
            data-talent-specialties={person.specialties ? person.specialties.join(', ') : person.specialty}
            data-talent-description={person.description}
            data-talent-image={person.image}
            data-talent-location={person.location}
            data-talent-birth={person.birth}
            data-talent-age={person.age}
            data-talent-height={person.height}
            data-talent-eyecolor={person.eyeColor}
            data-talent-haircolor={person.hairColor}
            data-talent-shoesize={person.shoeSize}
            data-talent-dresssize={person.dressSize}
            data-talent-imgs={person.imgs ? JSON.stringify(person.imgs) : ''}
            data-talent-portfoliourl={person.portfolioUrl || ''}
            data-talent-personalinfo={person.personalInfo ? JSON.stringify(person.personalInfo) : ''}
          >
            <div class="aspect-[2/3] bg-default/20 flex items-center justify-center relative">
              {person.image && person.image.trim() !== "" ? (
                <Image
                  src={person.image}
                  alt={`${person.name} - ${person.specialty}`}
                  class="w-full h-full object-cover"
                  width={200}
                  height={300}
                />
              ) : (
                <span class="text-default/60 text-xs">Photo Coming Soon</span>
              )}
              <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-2 text-white">
                <div class="space-y-1">
                  <div class="text-white">
                    <h3 class="font-bold text-sm leading-tight">{person.name}</h3>
                  </div>
                  <div class="flex flex-wrap gap-1 items-center min-w-0">
                    {person.location && (
                      <div class="bg-black/40 text-white text-xs py-0.5 px-1.5 rounded-full backdrop-blur-sm flex items-center min-w-0">
                        <span class="mr-1">üìç</span>{person.location}
                      </div>
                    )}
                    {person.birth && (
                      <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm min-w-0" title="Birth">
                        {person.birth}
                      </span>
                    )}
                  </div>
                  <div class="text-xs text-default/80 truncate" title={person.specialties ? person.specialties.join(', ') : person.specialty}>
                    {person.specialties ? person.specialties.join(', ') : person.specialty}
                  </div>
                  <div class="text-xs text-default/60 truncate" title={person.type}>{person.type}</div>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* Mobile Grid Layout */}
      <div class="md:hidden">
        <div class="grid grid-cols-2 gap-4" id="people-grid-mobile">
          {allPeople.map((person, index) => (
            <div
              class="talent-card bg-offset rounded-lg overflow-hidden shadow-lg cursor-pointer"
              data-type={person.type}
              data-talent-id={person.id}
              data-talent-name={person.name}
              data-talent-specialties={person.specialties ? person.specialties.join(', ') : person.specialty}
              data-talent-description={person.description}
              data-talent-image={person.image}
              data-talent-location={person.location}
              data-talent-birth={person.birth}
              data-talent-age={person.age}
              data-talent-height={person.height}
              data-talent-eyecolor={person.eyeColor}
              data-talent-haircolor={person.hairColor}
              data-talent-shoesize={person.shoeSize}
              data-talent-dresssize={person.dressSize}
              data-talent-imgs={person.imgs ? JSON.stringify(person.imgs) : ''}
              data-talent-portfoliourl={person.portfolioUrl || ''}
            data-talent-personalinfo={person.personalInfo ? JSON.stringify(person.personalInfo) : ''}
            >
              <div class="aspect-[3/4] bg-default/20 flex items-center justify-center relative">
                {person.image && person.image.trim() !== "" ? (
                  <Image
                    src={person.image}
                    alt={`${person.name} - ${person.specialty}`}
                    class="w-full h-full object-cover"
                    width={160}
                    height={200}
                  />
                ) : (
                  <span class="text-default/60 text-xs">Photo Coming Soon</span>
                )}
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-2 text-white">
                  <div class="space-y-1">
                    <div class="text-white">
                      <h3 class="font-bold text-xs leading-tight">{person.name}</h3>
                    </div>
                    <div class="flex flex-wrap gap-1 items-center min-w-0">
                      {person.location && (
                        <div class="bg-black/40 text-white text-xs py-0.5 px-1 rounded-full backdrop-blur-sm flex items-center min-w-0">
                          <span class="mr-0.5 text-xs">üìç</span><span class="text-xs">{person.location}</span>
                        </div>
                      )}
                    </div>
                    <div class="text-xs text-default/80 truncate" title={person.specialties ? person.specialties.join(', ') : person.specialty}>
                      {person.specialties ? person.specialties.join(', ') : person.specialty}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </>
  )}
</ContentSection>

<!-- Inject data for client-side filtering -->
<script type="application/json" id="people-data">{JSON.stringify(allPeople)}</script>

<!-- Include the extracted modal component -->
<TalentModalComponent />

<script>
  // Client-side filtering functionality
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Setting up filter functionality');
    
    // Debug: Check if modal component is properly loaded
    console.log('üîç Checking modal availability immediately...');
    console.log('Available window functions:', Object.keys(window).filter(key => 
      key.toLowerCase().includes('modal') || key.toLowerCase().includes('talent')
    ));
    console.log('openTalentModal type:', typeof window.openTalentModal);
    
    // Check if modal DOM element exists
    const modalElement = document.getElementById('talent-modal');
    console.log('Modal DOM element found:', !!modalElement);
    
    // Add a delay to check again after components load
    setTimeout(() => {
      console.log('üîç Checking modal availability after 1000ms...');
      console.log('Available window functions:', Object.keys(window).filter(key => 
        key.toLowerCase().includes('modal') || key.toLowerCase().includes('talent')
      ));
      console.log('openTalentModal type:', typeof window.openTalentModal);
      const modalElementLater = document.getElementById('talent-modal');
      console.log('Modal DOM element found after delay:', !!modalElementLater);
    }, 1000);

    const filterButtons = document.querySelectorAll('.filter-btn');
    const desktopCards = document.querySelectorAll('#people-grid-desktop .talent-card');
    const mobileCards = document.querySelectorAll('#people-grid-mobile .talent-card');
    const allTalentCards = document.querySelectorAll('.talent-card'); // Keep this for backward compatibility
    let currentFilter = 'ALL';

    // Set initial active state
    updateActiveButton('ALL');

    // Debug logging
    console.log('Desktop cards found:', desktopCards.length);
    console.log('Mobile cards found:', mobileCards.length);
    console.log('All talent cards found:', allTalentCards.length);
    console.log('Screen width:', window.innerWidth);
    console.log('Desktop grid element:', document.getElementById('people-grid-desktop'));
    console.log('Desktop grid computed style:', getComputedStyle(document.getElementById('people-grid-desktop')).display);

    // Mobile grid functionality (no carousel needed)
    // Variables removed as carousel is no longer used

    // Ensure initial visibility of cards
    filterCards('ALL');

    // Set up click handlers immediately
    setupClickHandlers();
    
    // Also try setting up after we confirm modal is available
    setTimeout(() => {
      if (typeof window.openTalentModal === 'function') {
        console.log('üîß Modal function found after delay, setting up handlers again');
        setupClickHandlers();
      } else {
        console.error('‚ùå Modal function still not found after 1000ms delay');
      }
    }, 1000);

    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        const filter = this.getAttribute('data-filter');
        currentFilter = filter;

        // Update active button state
        updateActiveButton(filter);

        // Filter cards for both desktop and mobile
        filterCards(filter);
      });
    });

    function updateActiveButton(activeFilter) {
      filterButtons.forEach(btn => {
        const btnFilter = btn.getAttribute('data-filter');
        if (btnFilter === activeFilter) {
          // Apply selected filter styling
          btn.style.borderWidth = '2px';
          btn.style.borderColor = 'white';
          btn.style.fontWeight = '800';
          btn.style.backgroundColor = 'var(--color-primary)';
          btn.style.color = 'white';
          btn.classList.remove('bg-white/20');
        } else {
          // Apply unselected filter styling
          btn.style.borderWidth = '';
          btn.style.borderColor = '';
          btn.style.fontWeight = '';
          btn.style.backgroundColor = '';
          btn.style.color = '';
          btn.classList.add('bg-white/20');
        }
      });
    }

    function filterCards(filter) {
      console.log('Filtering cards for:', filter);
      
      // Filter desktop cards
      desktopCards.forEach(card => {
        const cardType = card.getAttribute('data-type');
        if (filter === 'ALL' || cardType === filter) {
          card.style.display = '';  // Reset to default display instead of 'block'
          card.classList.add('fade-in');
        } else {
          card.style.display = 'none';
          card.classList.remove('fade-in');
        }
      });

      // Filter mobile cards
      mobileCards.forEach(card => {
        const cardType = card.getAttribute('data-type');
        if (filter === 'ALL' || cardType === filter) {
          card.style.display = '';  // Reset to default display instead of 'block'
          card.classList.add('fade-in');
        } else {
          card.style.display = 'none';
          card.classList.remove('fade-in');
        }
      });
      
      console.log('Visible desktop cards:', Array.from(desktopCards).filter(card => card.style.display !== 'none').length);
      console.log('Visible mobile cards:', Array.from(mobileCards).filter(card => card.style.display !== 'none').length);
    }

    // Mobile grid functionality (no carousel functions needed)

    // Function to set up click handlers
    function setupClickHandlers() {
      const currentAllTalentCards = document.querySelectorAll('.talent-card');
      console.log('Setting up click handlers for', currentAllTalentCards.length, 'cards');
      console.log('openTalentModal available:', typeof window.openTalentModal === 'function');
      
      if (currentAllTalentCards.length === 0) {
        console.warn('No talent cards found!');
        return;
      }
      
      currentAllTalentCards.forEach((card, index) => {
        console.log(`Setting up click handler for card ${index + 1}:`, card.getAttribute('data-talent-name'));
        
        // Remove any existing click handler to avoid duplicates
        card.removeEventListener('click', handleCardClick);
        
        card.addEventListener('click', handleCardClick);
      });
    }

    // Card click handler function
    function handleCardClick(e) {
      e.preventDefault();
      console.log('Card clicked:', this.getAttribute('data-talent-name'));

      var id = this.getAttribute('data-talent-id');
      var name = this.getAttribute('data-talent-name');
      var specialties = this.getAttribute('data-talent-specialties');
      var description = this.getAttribute('data-talent-description');
      var image = this.getAttribute('data-talent-image');
      var location = this.getAttribute('data-talent-location');
      var birth = this.getAttribute('data-talent-birth');
      var age = this.getAttribute('data-talent-age');
      var height = this.getAttribute('data-talent-height');
      var eyeColor = this.getAttribute('data-talent-eyecolor');
      var hairColor = this.getAttribute('data-talent-haircolor');
      var shoeSize = this.getAttribute('data-talent-shoesize');
      var dressSize = this.getAttribute('data-talent-dresssize');
      var imgs = this.getAttribute('data-talent-imgs');
      var portfolioUrl = this.getAttribute('data-talent-portfoliourl');
      var personalInfo = this.getAttribute('data-talent-personalinfo');

      // Parse imgs JSON string back to array
      var imgsArray = [];
      if (imgs && imgs !== "") {
        try {
          imgsArray = JSON.parse(imgs);
        } catch (e) {
          console.error('Error parsing imgs:', e);
        }
      }

      // Parse personalInfo JSON string back to object
      var personalInfoObj = {};
      if (personalInfo && personalInfo !== "") {
        try {
          personalInfoObj = JSON.parse(personalInfo);
        } catch (e) {
          console.error('Error parsing personalInfo:', e);
        }
      }

      console.log('Opening modal for talent:', { id, name, specialties, description, image, location, birth, age, height, eyeColor, hairColor, shoeSize, dressSize, imgsArray, portfolioUrl, personalInfoObj });

      // Set global event for openTalentModal
      window.event = e;

      // Call the modal function
      if (typeof window.openTalentModal === 'function') {
        console.log('Calling openTalentModal function');
        window.openTalentModal(id, name, specialties, description, image, location, birth, age, height, eyeColor, hairColor, shoeSize, dressSize, imgsArray, portfolioUrl, personalInfoObj);
      } else {
        console.error('openTalentModal function not found');
      }
    }

    // Set up view profile button event listeners (keeping for backward compatibility)
    var viewProfileBtns = document.querySelectorAll('.view-profile-btn');
    console.log('Found', viewProfileBtns.length, 'view profile buttons');
    
    for (var i = 0; i < viewProfileBtns.length; i++) {
      viewProfileBtns[i].addEventListener('click', function(e) {
        e.preventDefault();
        var btn = e.currentTarget;
        var id = btn.getAttribute('data-talent-id');
        var name = btn.getAttribute('data-talent-name');
        var specialties = btn.getAttribute('data-talent-specialties');
        var description = btn.getAttribute('data-talent-description');
        var image = btn.getAttribute('data-talent-image');
        var location = btn.getAttribute('data-talent-location');
        var birth = btn.getAttribute('data-talent-birth');
        var age = btn.getAttribute('data-talent-age');
        var height = btn.getAttribute('data-talent-height');
        var eyeColor = btn.getAttribute('data-talent-eyecolor');
        var hairColor = btn.getAttribute('data-talent-haircolor');
        var shoeSize = btn.getAttribute('data-talent-shoesize');
        var dressSize = btn.getAttribute('data-talent-dresssize');
        var imgs = btn.getAttribute('data-talent-imgs');
        var portfolioUrl = btn.getAttribute('data-talent-portfoliourl');
        var personalInfo = btn.getAttribute('data-talent-personalinfo');
        
        // Parse imgs JSON string back to array
        var imgsArray = [];
        if (imgs && imgs !== "") {
          try {
            imgsArray = JSON.parse(imgs);
          } catch (e) {
            console.error('Error parsing imgs:', e);
          }
        }

        // Parse personalInfo JSON string back to object
        var personalInfoObj = {};
        if (personalInfo && personalInfo !== "") {
          try {
            personalInfoObj = JSON.parse(personalInfo);
          } catch (e) {
            console.error('Error parsing personalInfo:', e);
          }
        }
        
        console.log('Opening modal for talent:', { id, name, specialties, description, image, location, birth, age, height, eyeColor, hairColor, shoeSize, dressSize, imgsArray, portfolioUrl });
        
        // Set global event for openTalentModal
        window.event = e;
        
        // Call the modal function
        if (typeof window.openTalentModal === 'function') {
          window.openTalentModal(id, name, specialties, description, image, location, birth, age, height, eyeColor, hairColor, shoeSize, dressSize, imgsArray, portfolioUrl, personalInfoObj);
        } else {
          console.error('openTalentModal function not found');
        }
      });
    }
  });
</script>

<style>
  /* Fix flex wrapping issues by ensuring flex children have min-width: 0 */
  .flex > * {
    min-width: 0;
  }
  
  .flex-wrap > * {
    min-width: 0;
  }
  
  .inline-flex > * {
    min-width: 0;
  }
  
  /* Specific fixes for talent card flex containers */
  .talent-card .flex > * {
    min-width: 0;
    flex-shrink: 1;
  }
  
  .talent-card .flex-wrap > * {
    min-width: 0;
    flex-shrink: 1;
  }
  
  /* Responsive flex fixes */
  @media (min-width: 768px) {
    .md\:flex > * {
      min-width: 0;
    }
  }
  
  @media (min-width: 1024px) {
    .lg\:flex > * {
      min-width: 0;
    }
    
    .lg\:flex-row > * {
      min-width: 0;
    }
    
    .lg\:flex-col > * {
      min-width: 0;
    }
  }
  
  /* Grid fixes for similar issues */
  .grid > * {
    min-width: 0;
  }
  
  /* Specific button flex fixes */
  .view-profile-btn .inline-flex > * {
    min-width: 0;
    flex-shrink: 0; /* Prevent button content from shrinking */
  }
  
  /* Tag and badge flex fixes */
  .flex.gap-1 > span,
  .flex.flex-wrap > span {
    min-width: 0;
    flex-shrink: 0; /* Prevent tags from shrinking too much */
  }

  /* Performance-optimized animations */
  .talent-card {
    transition-duration: var(--animation-duration, 0.3s);
    transition-timing-function: var(--animation-easing, cubic-bezier(0.4, 0, 0.2, 1));
  }

  .view-profile-btn {
    transition-duration: var(--animation-duration, 0.3s);
    transition-timing-function: var(--animation-easing, cubic-bezier(0.4, 0, 0.2, 1));
  }

  /* Optimizations for better LCP */
  .talent-card img {
    content-visibility: auto;
    contain-intrinsic-size: 200px 300px;
  }

  /* Prevent layout shifts for better CLS */
  .talent-card {
    contain: layout style;
  }

  .talent-card .aspect-\[2\/3\] {
    min-height: 300px; /* Explicit height to prevent CLS */
  }

  /* Reduce motion for users who prefer it */
  @media (prefers-reduced-motion: reduce) {
    .talent-card,
    .view-profile-btn {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      transition-delay: 0s !important;
    }
    
    .talent-card:hover {
      transform: none !important;
    }
  }

  /* Performance mode styles */
  .performance-mode .talent-card {
    transition-duration: 0.1s !important;
    will-change: auto !important;
  }

  .performance-mode .talent-card:hover {
    transform: scale(1.01) !important;
  }

  /* Critical CSS for above-the-fold content */
  .talent-card:nth-child(-n+4) {
    contain: none; /* Allow critical cards to render faster */
  }

  .talent-card:nth-child(-n+4) img {
    loading: eager;
    fetchpriority: high;
  }

  /* Filter button animations */
  .filter-btn {
    transition: all 0.3s ease;
    border-width: 1px; /* Default border width */
  }

  .filter-btn:hover {
    transform: translateY(-1px);
  }

  /* Active/selected filter button styling */
  .filter-btn.active,
  .filter-btn.bg-primary {
    border-width: 2px; /* Thicker border for selected state */
    border-color: white; /* White stroke for selected state */
    font-weight: 800 !important; /* Extra bold text for selected state */
    background-color: var(--color-primary) !important; /* Purple fill for selected state */
    color: white !important; /* White text for contrast */
  }

  /* Yellow oval count badge */
  .filter-count-badge {
    background-color: #fbbf24; /* Yellow color */
    color: #1f2937; /* Dark text for contrast */
    padding: 0.25rem 0.625rem;
    border-radius: 9999px; /* Full rounded/oval shape */
    font-size: 0.75rem;
    font-weight: 700; /* Bold font weight */
    min-width: 1.5rem;
    text-align: center;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  /* Card fade animation */
  .talent-card {
    transition: all 0.3s ease;
  }

  .fade-in {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Mobile Grid Styles */
  @media (max-width: 767px) {
    #people-grid-mobile {
      padding: 0 16px;
    }
    
    #people-grid-mobile .talent-card {
      transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    }
    
    #people-grid-mobile .talent-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    #people-grid-mobile .aspect-\[3\/4\] {
      min-height: 240px; /* Increased from 200px by 20% (200 * 1.2 = 240px) */
    }
  }

  /* Desktop grid visibility fix */
  @media (min-width: 768px) {
    #people-grid-desktop {
      display: grid !important;
    }
  }

  @media (max-width: 767px) {
    #people-grid-desktop {
      display: none !important;
    }
  }
</style>
