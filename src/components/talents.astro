---
import Image from "astro/components/Image.astro";
import ContentSection from "~/components/content-section.astro";
import TalentModalComponent from "~/components/talent-modal-component.astro";
import { getTalents } from "~/lib/talents";
import { getCreatives } from "~/lib/creatives";

// Fetch talents and creatives from Firebase
let talents = [];
let creatives = [];
let allPeople = [];
try {
  const allTalents = await getTalents();
  const allCreatives = await getCreatives();
  console.log('Fetched talents:', allTalents);
  console.log('Fetched creatives:', allCreatives);
  talents = allTalents.filter(talent => talent.enabled == true).map(t => ({ ...t, type: 'Talent' }));
  creatives = allCreatives.filter(creative => creative.enabled == true).map(c => ({ ...c, type: 'Creative' }));
  allPeople = [...talents, ...creatives];
  console.log('Combined and filtered people:', allPeople);
} catch (error) {
  console.error('Failed to load talents or creatives:', error);
}

// Filtering logic
const FILTERS = [
  { label: 'ALL', value: 'ALL' },
  { label: 'Talent', value: 'Talent' },
  { label: 'Creative', value: 'Creative' },
  // Add more filters as needed, e.g., Actress, Model, etc.
];
let selectedFilter = 'ALL';

function getFilteredPeople() {
  if (selectedFilter === 'ALL') return allPeople;
  return allPeople.filter(person => person.type === selectedFilter);
}

function getCount(type) {
  if (type === 'ALL') return allPeople.length;
  return allPeople.filter(person => person.type === type).length;
}
---

<ContentSection title="Talent" id="talents">
  <Fragment slot="lead">
    Discover our <span class="text-primary">exceptional talent & creative pool</span> ready to bring your vision to life.
  </Fragment>

  {/* Filter Buttons */}
  <div class="flex flex-wrap gap-2 mb-6 justify-center" id="filter-buttons">
    {FILTERS.map(filter => (
      <button
        class="filter-btn px-4 py-1 rounded-full border border-default/30 bg-white/80 hover:bg-primary/10 transition text-sm font-medium flex items-center gap-2"
        type="button"
        data-filter={filter.value}
      >
        {filter.label}
        <span class="ml-1 bg-default/10 rounded-full px-2 py-0.5 text-xs font-semibold">{getCount(filter.value)}</span>
      </button>
    ))}
  </div>

  {allPeople.length === 0 ? (
    <div class="text-center py-8">
      <p class="text-default/60">No profiles available at the moment. Please check back later.</p>
    </div>
  ) : (
    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4" id="people-grid">
      {allPeople.map((person) => (
        <div
          class="talent-card bg-offset rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer"
          data-type={person.type}
          data-talent-id={person.id}
          data-talent-name={person.name}
          data-talent-specialties={person.specialties ? JSON.stringify(person.specialties) : person.specialty}
          data-talent-description={person.description}
          data-talent-image={person.image}
          data-talent-location={person.location}
          data-talent-birth={person.birth}
          data-talent-age={person.age}
          data-talent-height={person.height}
          data-talent-eyecolor={person.eyeColor}
          data-talent-haircolor={person.hairColor}
          data-talent-shoesize={person.shoeSize}
          data-talent-dresssize={person.dressSize}
          data-talent-imgs={person.imgs ? JSON.stringify(person.imgs) : ''}
          data-talent-portfoliourl={person.portfolioUrl || ''}
        >
          <div class="aspect-[2/3] bg-default/20 flex items-center justify-center relative">
            {person.image && person.image.trim() !== "" ? (
              <Image
                src={person.image}
                alt={`${person.name} - ${person.specialty}`}
                class="w-full h-full object-cover"
                width={200}
                height={300}
              />
            ) : (
              <span class="text-default/60 text-xs">Photo Coming Soon</span>
            )}
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-2 text-white">
              <div class="space-y-1">
                <div class="text-white">
                  <h3 class="font-bold text-sm leading-tight">{person.name}</h3>
                </div>
                <div class="flex flex-wrap gap-1 items-center min-w-0">
                  {person.location && (
                    <div class="bg-black/40 text-white text-xs py-0.5 px-1.5 rounded-full backdrop-blur-sm flex items-center min-w-0">
                      <span class="mr-1">üìç</span>{person.location}
                    </div>
                  )}
                  {person.birth && (
                    <span class="text-xs text-white bg-black/30 px-1.5 py-0.5 rounded backdrop-blur-sm min-w-0" title="Birth">
                      {person.birth}
                    </span>
                  )}
                </div>
                <div class="text-xs text-default/80 truncate" title={person.specialty}>{person.specialty}</div>
                <div class="text-xs text-default/60 truncate" title={person.type}>{person.type}</div>
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>
  )}
</ContentSection>

<!-- Inject data for client-side filtering -->
<script type="application/json" id="people-data">{JSON.stringify(allPeople)}</script>

<!-- Include the extracted modal component -->
<TalentModalComponent />

<script>
  // Client-side filtering functionality
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Setting up filter functionality');

    const filterButtons = document.querySelectorAll('.filter-btn');
    const talentCards = document.querySelectorAll('.talent-card');
    let currentFilter = 'ALL';

    // Set initial active state
    updateActiveButton('ALL');

    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        const filter = this.getAttribute('data-filter');
        currentFilter = filter;

        // Update active button state
        updateActiveButton(filter);

        // Filter cards
        filterCards(filter);
      });
    });

    function updateActiveButton(activeFilter) {
      filterButtons.forEach(btn => {
        const btnFilter = btn.getAttribute('data-filter');
        if (btnFilter === activeFilter) {
          btn.classList.add('bg-primary', 'text-white');
          btn.classList.remove('bg-white/80');
        } else {
          btn.classList.remove('bg-primary', 'text-white');
          btn.classList.add('bg-white/80');
        }
      });
    }

    function filterCards(filter) {
      talentCards.forEach(card => {
        const cardType = card.getAttribute('data-type');

        if (filter === 'ALL' || cardType === filter) {
          card.style.display = 'block';
          card.classList.add('fade-in');
        } else {
          card.style.display = 'none';
          card.classList.remove('fade-in');
        }
      });
    }

    // Set up talent card click event listeners
    talentCards.forEach(card => {
      card.addEventListener('click', function(e) {
        e.preventDefault();

        var id = this.getAttribute('data-talent-id');
        var name = this.getAttribute('data-talent-name');
        var specialties = this.getAttribute('data-talent-specialties');
        var description = this.getAttribute('data-talent-description');
        var image = this.getAttribute('data-talent-image');
        var location = this.getAttribute('data-talent-location');
        var birth = this.getAttribute('data-talent-birth');
        var age = this.getAttribute('data-talent-age');
        var height = this.getAttribute('data-talent-height');
        var eyeColor = this.getAttribute('data-talent-eyecolor');
        var hairColor = this.getAttribute('data-talent-haircolor');
        var shoeSize = this.getAttribute('data-talent-shoesize');
        var dressSize = this.getAttribute('data-talent-dresssize');
        var imgs = this.getAttribute('data-talent-imgs');
        var portfolioUrl = this.getAttribute('data-talent-portfoliourl');

        // Parse imgs JSON string back to array
        var imgsArray = [];
        if (imgs && imgs !== "") {
          try {
            imgsArray = JSON.parse(imgs);
          } catch (e) {
            console.error('Error parsing imgs:', e);
          }
        }

        console.log('Opening modal for talent:', { id, name, specialties, description, image, location, birth, age, height, eyeColor, hairColor, shoeSize, dressSize, imgsArray, portfolioUrl });

        // Set global event for openTalentModal
        window.event = e;

        // Call the modal function
        if (typeof window.openTalentModal === 'function') {
          window.openTalentModal(id, name, specialties, description, image, location, birth, age, height, eyeColor, hairColor, shoeSize, dressSize, imgsArray, portfolioUrl);
        } else {
          console.error('openTalentModal function not found');
        }
      });
    });

    // Set up view profile button event listeners (keeping for backward compatibility)
    var viewProfileBtns = document.querySelectorAll('.view-profile-btn');
    console.log('Found', viewProfileBtns.length, 'view profile buttons');
    
    for (var i = 0; i < viewProfileBtns.length; i++) {
      viewProfileBtns[i].addEventListener('click', function(e) {
        e.preventDefault();
        var btn = e.currentTarget;
        var id = btn.getAttribute('data-talent-id');
        var name = btn.getAttribute('data-talent-name');
        var specialties = btn.getAttribute('data-talent-specialties');
        var description = btn.getAttribute('data-talent-description');
        var image = btn.getAttribute('data-talent-image');
        var location = btn.getAttribute('data-talent-location');
        var birth = btn.getAttribute('data-talent-birth');
        var age = btn.getAttribute('data-talent-age');
        var height = btn.getAttribute('data-talent-height');
        var eyeColor = btn.getAttribute('data-talent-eyecolor');
        var hairColor = btn.getAttribute('data-talent-haircolor');
        var shoeSize = btn.getAttribute('data-talent-shoesize');
        var dressSize = btn.getAttribute('data-talent-dresssize');
        var imgs = btn.getAttribute('data-talent-imgs');
        var portfolioUrl = btn.getAttribute('data-talent-portfoliourl');
        
        // Parse imgs JSON string back to array
        var imgsArray = [];
        if (imgs && imgs !== "") {
          try {
            imgsArray = JSON.parse(imgs);
          } catch (e) {
            console.error('Error parsing imgs:', e);
          }
        }
        
        console.log('Opening modal for talent:', { id, name, specialties, description, image, location, birth, age, height, eyeColor, hairColor, shoeSize, dressSize, imgsArray, portfolioUrl });
        
        // Set global event for openTalentModal
        window.event = e;
        
        // Call the modal function
        if (typeof window.openTalentModal === 'function') {
          window.openTalentModal(id, name, specialties, description, image, location, birth, age, height, eyeColor, hairColor, shoeSize, dressSize, imgsArray, portfolioUrl);
        } else {
          console.error('openTalentModal function not found');
        }
      });
    }
  });
</script>

<style>
  /* Fix flex wrapping issues by ensuring flex children have min-width: 0 */
  .flex > * {
    min-width: 0;
  }
  
  .flex-wrap > * {
    min-width: 0;
  }
  
  .inline-flex > * {
    min-width: 0;
  }
  
  /* Specific fixes for talent card flex containers */
  .talent-card .flex > * {
    min-width: 0;
    flex-shrink: 1;
  }
  
  .talent-card .flex-wrap > * {
    min-width: 0;
    flex-shrink: 1;
  }
  
  /* Responsive flex fixes */
  @media (min-width: 768px) {
    .md\:flex > * {
      min-width: 0;
    }
  }
  
  @media (min-width: 1024px) {
    .lg\:flex > * {
      min-width: 0;
    }
    
    .lg\:flex-row > * {
      min-width: 0;
    }
    
    .lg\:flex-col > * {
      min-width: 0;
    }
  }
  
  /* Grid fixes for similar issues */
  .grid > * {
    min-width: 0;
  }
  
  /* Specific button flex fixes */
  .view-profile-btn .inline-flex > * {
    min-width: 0;
    flex-shrink: 0; /* Prevent button content from shrinking */
  }
  
  /* Tag and badge flex fixes */
  .flex.gap-1 > span,
  .flex.flex-wrap > span {
    min-width: 0;
    flex-shrink: 0; /* Prevent tags from shrinking too much */
  }

  /* Performance-optimized animations */
  .talent-card {
    transition-duration: var(--animation-duration, 0.3s);
    transition-timing-function: var(--animation-easing, cubic-bezier(0.4, 0, 0.2, 1));
  }

  .view-profile-btn {
    transition-duration: var(--animation-duration, 0.3s);
    transition-timing-function: var(--animation-easing, cubic-bezier(0.4, 0, 0.2, 1));
  }

  /* Optimizations for better LCP */
  .talent-card img {
    content-visibility: auto;
    contain-intrinsic-size: 200px 300px;
  }

  /* Prevent layout shifts for better CLS */
  .talent-card {
    contain: layout style;
  }

  .talent-card .aspect-\[2\/3\] {
    min-height: 300px; /* Explicit height to prevent CLS */
  }

  /* Reduce motion for users who prefer it */
  @media (prefers-reduced-motion: reduce) {
    .talent-card,
    .view-profile-btn {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      transition-delay: 0s !important;
    }
    
    .talent-card:hover {
      transform: none !important;
    }
  }

  /* Performance mode styles */
  .performance-mode .talent-card {
    transition-duration: 0.1s !important;
    will-change: auto !important;
  }

  .performance-mode .talent-card:hover {
    transform: scale(1.01) !important;
  }

  /* Critical CSS for above-the-fold content */
  .talent-card:nth-child(-n+4) {
    contain: none; /* Allow critical cards to render faster */
  }

  .talent-card:nth-child(-n+4) img {
    loading: eager;
    fetchpriority: high;
  }

  /* Filter button animations */
  .filter-btn {
    transition: all 0.3s ease;
  }

  .filter-btn:hover {
    transform: translateY(-1px);
  }

  /* Card fade animation */
  .talent-card {
    transition: all 0.3s ease;
  }

  .fade-in {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
